function parseBool(a){return!/^(false|0)$/i.test(a)&&!!a}!function(a){var b=a({});a.ajaxQueue=function(c){function d(b){e=a.ajax(c).done(f.resolve).fail(f.reject).then(b,b)}var e,f=a.Deferred(),g=f.promise();return b.queue(d),g.abort=function(h){if(e)return e.abort(h);var i=b.queue(),j=a.inArray(d,i);return j>-1&&i.splice(j,1),f.rejectWith(c.context||c,[g,h,""]),g},g}}(jQuery);var integrumDash={objects:[],hierarchytree:1,initdata:void 0,register:function(a,b){0>b?integrumDash.objects.push(a):integrumDash.objects.unshift(a),this.initdata&&a.init(this.initdata)},init:function(a){this.initdata=a;for(var b=0;b<this.objects.length;++b)this.objects[b].init($(this),a);this.getHierarchy(),$(document).on("tree-selected",function(){integrumDash.getHierarchy()})},loaddata:function(a){for(var b=0;b<this.objects.length;++b)this.objects[b].loaddata(a)},getHierarchy:function(){var a=getCurrentRegionHierarchy(),b=a.id;null!=b&&integrumDash.loaddata(a)}};jQuery(document).ready(function(a){a(".navbar-fixed-top").css("margin-top","-50px"),a("#ds-a-menu").click(function(){return"active"!=a("#navbar-backdrop").attr("class")?(a(".navbar-fixed-top").animate({marginTop:"0px"},500),a("#navbar-arrow-dropdown").hide(),a("#navbar-backdrop").addClass("active"),!1):void 0}),a("#navbar-backdrop").click(function(){return a(".navbar-fixed-top").animate({marginTop:"-50px"},500),a("#navbar-arrow-dropdown").show(),a("#navbar-backdrop").removeClass(),!1}),a('[data-toggle="tooltip"]').tooltip(),a(document).on("map-received-state",function(b,c,d){d.hasOwnProperty("attributes")&&a.each(d.attributes,function(b,c){for(var e in c){var f=a("audio.state."+b+"-"+c[e]+'[data-layer="'+d.layerCode+'"]');f.length>0&&f[0].play()}})})}),jQuery(document).ready(function(a){function b(a){f(a)}function c(c){a.ajaxQueue({dataType:"json",url:"/websocket/options",success:function(c){var d=c.mapoptions,e=g();h={uri:e+"://"+d.uri+"/maps-web-service/webregisterstatelistener/1/",mapLinkCallback:b,urlPrefix:a(window.location).attr("protocol")+"//"+d.uri,assetsPath:"/assets/",showEditButton:!1,showDownloadButton:a("#permMapEdit").val(),token:c.token,lang:c.lang||navigator.language||navigator.userLanguage,respOkCode:"1"}}}).done(function(){f(c)})}function d(c){a.ajaxQueue({dataType:"json",url:"/websocket/options",success:function(c){var d=a(window.location).attr("host"),e=g();h={uri:e+"://"+d+"/maps/maps-web-service/webregisterstatelistener/1/",mapLinkCallback:b,urlPrefix:"/maps",assetsPath:"/assets/",showEditButton:!1,showDownloadButton:a("#permMapEdit").val(),token:c.token,lang:c.lang||navigator.language||navigator.userLanguage,respOkCode:"1"}}}).done(function(){f(c)})}function e(){var b=a.Deferred(),c=a('<div class="centered"></div>');return c.append("Podaj hasło:<br />"),c.append('<input class="form-control marginb-10" type="password" id="dialog-password"/><div class="alert alert-danger" role="alert" id="dialog-error" style="display:none;">Niepoprawne hasło!</div>'),BootstrapDialog.show({title:"Potwierdź",type:BootstrapDialog.TYPE_WARNING,message:c,closable:!1,onshown:function(a){a.$modal.find("#dialog-password")[0].focus()},buttons:[{label:"Anuluj",hotkey:27,action:function(a){a.close(),b.resolve(!0)}},{label:"OK",hotkey:13,cssClass:"btn-primary",action:function(c){var d=this;c.$modal.find("#dialog-error").hide();var e={pwd:c.$modal.find("#dialog-password").val()};d.spin(),a.post("logincheck",e,function(a){d.stopSpin(),a.ret?(b.resolve(!1),c.close()):(c.$modal.find("#dialog-error").show(),c.$modal.find("#dialog-password")[0].focus())},"json").fail(function(){d.stopSpin(),b.reject(),c.close()})}}]}),b.promise()}function f(b){var c=h;c.mapId=b,satelol3.init(c),i||(a(document).on("ws-alert",a.proxy(function(a,b){this.$dialog=BootstrapDialog.show({id:"map-message",title:"string"==typeof b?"Info":b[0],message:"string"==typeof b?b:b[1]})},this)),a(document).on("ws-alert-close",a.proxy(function(){this.$dialog&&(this.$dialog.close(),this.$dialog=void 0)},this)),a(document).on("feature-title-click",a.proxy(function(a,b){switch(b.layer_code){case"INT-INT":window.open("control/structure/"+b.feature_id,"integrum")}},this)),i=!0)}function g(){var b="ws";return"https:"===a(window.location).attr("protocol")&&(b="wss"),b}var h,i,j={loaddata:function(b){var e=b.id,f=a(window.location).attr("port");"81x"===f?c("h"+e):d("h"+e)},objDashboard:void 0,init:function(a){this.objDashboard=a}};a(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",function(){satelol3.fitMap()}),a("#permExtraAuth").val()&&a(satelol3).on("map-pre-action",function(a,b){b.cancel=e()}),integrumDash.register(j)}),function(a){var b={};b[a+"|loader"]=$("<div id='loader' class='loading'><i class='fa fa-cog fa-spin'></i></div>"),b[a+"|popup"]=$("<div id='popup' class='ol-popup'><a href='#' id='popup-closer' class='ol-popup-closer'></a><div id='popup-content' class='panel'></div></div>"),b[a+"|progress"]=$("<div id='progress'></div>"),b[a+"|panelWrapper"]=$("<div class='map-panel-wrapper' style='bottom: 0px;'><div class='panel-controller'><div class='tab-controller'><div id='map-title'></div><span class='closePanel' style='display: inline;'><i class='fa fa-arrow-down'></i></span><span class='showPanel' style='display: none;'><i class='fa  fa-arrow-up'></i></span></div></div><div class='panel-content'><div class='content clearfix'><div class='row'></div></div><!-- content --></div><!-- panel-content --></div>"),b[a+"|layerFeatureInfo"]=$("<div id='layerFeatureInfo'></div>"),b[a+"|timeInfo"]=$("<div id='timeInfo'></div>"),$.each(b,function(a,b){var c=/^([#a-z]*)\|/;if(c.test(a)){var d=c.exec(a);b.appendTo($(d[1]))}})}("#map"),window.app={};var app=window.app;jQuery.loadCSS=function(a){$('link[href="'+a+'"]').length||$("head").append('<link rel="stylesheet" type="text/css" href="'+a+'">')},app.TogglePanControl=function(a){var b=a||{},c=document.createElement("button");c.innerHTML='<i class="fa fa-mouse-pointer fa-stack-1x"></i>  <i class="fa fa-ban fa-stack-1x text-danger"></i>',c.title=WS.loaded.config.controls.panblock;var d=this,e=function(a){$(this).parents(".toggle-pan").hasClass("active")?($(this).parents(".toggle-pan").removeClass("active"),map.getInteractions().forEach(function(a){a instanceof ol.interaction.DragPan&&map.removeInteraction(a)}.bind(d))):($(this).parents(".toggle-pan").addClass("active"),map.addInteraction(new ol.interaction.DragPan))};c.addEventListener("click",e,!1),c.addEventListener("touchstart",e,!1);var f=document.createElement("div");f.className="toggle-pan ol-unselectable ol-control active",f.appendChild(c),ol.control.Control.call(this,{element:f,target:b.target})},app.RefreshControl=function(a){var b=a||{},c=document.createElement("button");c.innerHTML='<i class="fa fa-redo"></i>',c.title=WS.loaded.config.controls.reload;var d=function(a){WS.wsRequestState()};c.addEventListener("click",d,!1),c.addEventListener("touchstart",d,!1);var e=document.createElement("div");e.className="refresh ol-unselectable ol-control",e.appendChild(c),ol.control.Control.call(this,{element:e,target:b.target})},app.GoUpControl=function(a){var b=a||{},c=document.createElement("button"),d=WS.loaded.config;c.innerHTML='<i class="fa fa-level-up-alt"></i>',c.title=d.controls.parent;var e=function(a){0!==d.parentId&&WS.mapLink(d.parentId)};c.addEventListener("click",e,!1);var f=document.createElement("div");f.className="goup ol-unselectable ol-control",0!==d.parentId&&(f.className+=" active"),f.appendChild(c),ol.control.Control.call(this,{element:f,target:b.target})},app.EditModeControl=function(a){var b=a||{},c=document.createElement("button");c.innerHTML='<i class="fa fa-pencil"></i>';var d=document.createElement("div");d.className="editmode ol-unselectable ol-control";var e=function(a){app.editMode(),map.editMode?d.className+=" active":d.className=d.className.replace(" active","")};c.addEventListener("click",e,!1),d.appendChild(c),ol.control.Control.call(this,{element:d,target:b.target})},app.GetEditControl=function(a){var b=a||{},c=document.createElement("button");c.innerHTML='<i class="fa fa-download"></i>',c.title="MapEditor";var d=document.createElement("div");d.className=b.afterEdit?"mapeditor2 ol-unselectable ol-control active":"mapeditor ol-unselectable ol-control active";var e=function(a){var b=document.createElement("a");b.href="http://updates.satel.pl/mapeditor/v3.0/map_editor_setup.exe",b.target="_mapeditordownload",document.body.appendChild(b),b.click(),document.body.removeChild(b),delete b};c.addEventListener("click",e,!1),d.appendChild(c),ol.control.Control.call(this,{element:d,target:b.target})},app.findFeatureByReceivedData=function(a,b){var c=map.getLayerByLayerCode(a.layerCode);if(a.id){var d,e=Number(a.id);if(c){var f=c.getSource().getFeatures();f.forEach(function(a,b){var c=a.getProperties();return c.hasOwnProperty("id")&&Number(c.id)===e?(d=a,a):void 0})}else b.debugmode.states&&console.log("Layer not found:"+a.layerCode);return d}},app.zoomToFeature=function(a,b,c){var d=app.getFeature(a,b),e=d.getGeometry().getExtent();return d&&(bounce=ol.animation.bounce({resolution:map.getView().getResolution(),duration:1e3}),rotate=ol.animation.rotate({duration:1e3,rotation:0}),pan=ol.animation.pan({duration:1e3,source:map.getView().getCenter()}),zoom=ol.animation.zoom({duration:1e3,resolution:map.getView().getResolution()}),map.beforeRender(pan,zoom),c?map.getView().setCenter(ol.extent.getCenter(e)):map.getView().fit(e,map.getSize())),d},app.getFeature=function(a,b){var c,d=map.getLayerByLayerCode(b);return d.getSource().getFeatures().forEach(function(b){b.getId()===a&&(c=b)}),c},app.prepareLayer=function(a,b,c){var d=new ol.source.Vector({url:c.config.url.json+"/"+c.config.id+"/"+b.layerCode,format:new ol.format.GeoJSON({defaultDataProjection:defaultProjection})});d.vSourceId=a+1,deferredRequests[d.vSourceId]=$.Deferred();var e=(d.on("change",function(a){"ready"===this.getState()&&deferredRequests[this.vSourceId].resolve(this.vSourceId)}),new ol.layer.Vector({layerCode:b.layerCode,layerName:b.layerName,source:d,style:function f(a,b){var f=app.prepareStyle(a,b);return opt.debugmode.styles&&console.log(f),f}}));return e},app.modifyEnd=function(a){var b=a.features,c={};c.attributes=[],c.type="UpdateCoordinates",b.forEach(function(a){var b={};b.layer=a.get("layerCode"),b.id=a.getProperties().id(),b.coordinates=a.getGeometry().getCoordinates(),c.attributes.push(b)}),WS.wsSendMessage(JSON.stringify(c)),console.log(c)},app.editMode=function(){var a=map,b=this;if(a.editMode)a.getInteractions().forEach(function(b){(b instanceof ol.interaction.Modify||b instanceof ol.interaction.Select)&&a.removeInteraction(b)}),WS.wsRequestState(),a.editMode=!1;else{WS.defaultStyles();var c=new ol.interaction.Select({wrapX:!1}),d=new ol.interaction.Modify({features:c.getFeatures()});d.on("modifyend",b.modifyEnd),a.getInteractions().extend([c,d]),a.editMode=!0}},ol.inherits(app.TogglePanControl,ol.control.Control),ol.inherits(app.RefreshControl,ol.control.Control),ol.inherits(app.GoUpControl,ol.control.Control),ol.inherits(app.EditModeControl,ol.control.Control),ol.inherits(app.GetEditControl,ol.control.Control);var WS={options:{websocketUriBase:void 0,callback:void 0,mapLinkCallback:void 0,actionAttributeCallback:void 0,mapId:void 0,debugmode:void 0,urlPrefix:void 0,reuseConnection:!0,lang:navigator.language||navigator.userLanguage,respOkCode:"0"},refreshStateTimeOut:void 0,websocket:void 0,featureState:{},reconnectAttempts:1,manualDisconnect:!1,$content:void 0,$closer:void 0,actionEventsBinded:void 0,loaded:{},init:function(a){if($.extend(this.options,a),this.wsTimeout=setTimeout(this.wsTimeout,4e3),!this.options.mapId){var b=window.location.search,c=/\?(.*)$/.exec(b);c&&!/^r=/.test(c[1])&&(this.options.mapId=c[1]),this.options.mapId||(this.options.mapId="h1")}var d=document.createElement("a");if(d.href=this.options.websocketUriBase,"wss:"===d.protocol||"ws:"===d.protocol)this.websocketUri=this.options.websocketUriBase+this.options.mapId;else{var e,f=window.location;e="https:"===f.protocol?"wss:":"ws:",e+="//"+f.host,this.websocketUri=e+this.options.websocketUriBase+this.options.mapId}this.$content=$("#popup-content"),this.$closer=$("#popup-closer"),this.overlay=new ol.Overlay({element:$("#popup")[0]});try{try{this.websocket&&1===this.websocket.readyState&&!this.options.reuseConnection&&(this.wsSendCloseMessage(),this.websocket=void 0)}catch(g){console.log(g)}this.websocket&&this.options.reuseConnection?this.options.reuseConnection&&this.wsMapRequest(this.options.mapId):(this.websocket=new WebSocket(this.websocketUri),this.websocket.onopen=this.wsOnOpen.bind(this),this.websocket.onclose=this.wsOnClose.bind(this),this.websocket.onmessage=this.wsOnMessage.bind(this),this.websocket.onerror=this.wsOnError.bind(this))}catch(g){console.log(g)}},overlay:void 0,wsOnOpen:function(a){this.reconnectAttempts=1,this.manualDisconnect=!1,this.writeToReceivedBox("CONNECTED"),$(document).trigger("ws-open",a),setTimeout(function(){$(document).trigger("ws-alert-close")},1e3)},wsAddPopupEvents:function(){this.actionEventsBinded||(this.$content.on("click",".feature-title",function(a){$(document).trigger("feature-title-click",$(a.target).data())}),this.$content.on("click","a",this.doAction.bind(this)),this.$closer.on("click",function(){return WS.popupSetPosition(void 0),this.blur(),!1}),this.actionEventsBinded=!0)},popupSetPosition:function(a){WS.overlay.setPosition(a)},wsOnError:function(a){$(document).trigger("ws-error",a),this.writeToReceivedBox('<span style="color: red;">ERROR:</span> '+a.data)},wsOnMessage:function(a){var b=this;$(document).trigger("ws-pre-message",a),this.writeToReceivedBox(a.data);var c=JSON.parse(a.data);$.isArray(c)?$.each(c,function(a,c){b.onMessage(c)}):this.onMessage(c),$(document).trigger("ws-post-message",a)},onMessage:function(a){if(a.type)switch(a.type){case"Connected":this.wsMapRequest(this.options.mapId),clearTimeout(this.wsTimeout),$(document).trigger("ws-connected",a);break;case"State":this.wsReceivedState(a),$(document).trigger("ws-state",a);break;case"Notification":$(document).trigger("ws-notification",a);break;case"MapConfig":$("#mapnotfound").hide(),this.wsRreceivedConfig(a),$(document).trigger("ws-config",a);break;case"ActionResponse":switch($("#progress [data-cmd-id="+a["cmd-id"]+"]").remove(),$("#mapnotfound").hide(),a.respCode){case this.options.respOkCode:break;case"NOMAP":case"MAPNOTFOUND":$("#mapnotfound").show(),$("#loader").hide();break;default:a.respMessage?$(document).trigger("ws-alert",a.respMessage):$(document).trigger("ws-alert",a.respCode)}$(document).trigger("ws-action-response",a)}},wsOnClose:function(a){if(/^Apple/.test(navigator.vendor)&&1006===a.code)clearTimeout(this.wsTimeout),this.disposeLoader(),$(document).trigger("ws-alert",["Error","fatal error"]);else if($(document).trigger("ws-close",a),this.writeToReceivedBox("DISCONNECTED"),this.refreshStateTimeOut&&(clearTimeout(this.refreshStateTimeOut),this.refreshStateTimeOut=void 0),!this.manualDisconnect){var b=this.generateInterval(this.reconnectAttempts);setTimeout(function(){this.reconnectAttempts++,this.wsReconnect(),this.options.debugmode.websocket?console.log("Reconnecting attempt:"+this.reconnectAttempts+" in "+parseInt(b)+"ms"):null}.bind(this),b)}},wsMapRequest:function(a){this.options.mapId=a;var b={type:"ConfigRequest",token:this.options.token,id:a,action:this.options.lang};this.wsSendMessage(JSON.stringify(b))},wsSendMessage:function(a){if(1!==this.websocket.readyState)return this.options.debugmode.websocket?console.log(a):null,!1;var b;try{var c=JSON.parse(a),d=$.grep(this.loaded.config.layers,function(a){return a.layerCode===c.layer})[0],e=$.grep(d.actions,function(a){return a.actionCode===c.action})[0];b=new Date(parseInt(c["cmd-id"])).toLocaleTimeString()+" "+d.layerName+" -> "+e.descr}catch(f){}if(c.type&&"Action"===c.type){if(c.confirm&&!confirm(this.loaded.config.controls.confirm))return!1;var g=$("<i/>",{"class":"fa fa-cog fa-spin","data-cmd-id":c["cmd-id"]});$("#progress").append(g)}this.writeToSentBox(a),this.websocket.send(a)},wsReconnect:function(){$("#progress").empty();var a,b;this.loaded.config?(a=this.loaded.config.controls.disconnected,b=this.loaded.config.controls["disconnected-msg"]):(a="Rozłączono",b="Próbuję ponownie połączyć"),$(document).trigger("ws-alert",[a,b]),this.init(this.options)},wsTimeout:function(a){$(document).trigger("ws-timeout",a);var b,c;this.loaded&&this.loaded.config?(b=this.loaded.config.controls.contimeout,c=this.loaded.config.controls["contimeout-msg"]):(b="Timeout",c="Przekroczony czas połączenia."),$(document).trigger("ws-alert",[b,c])},wsRreceivedConfig:function(a){$(document).trigger("ws-received-config",a),this.loaded.config=a,this.loaded.config.url={},this.loaded.config.url.json=this.options.urlPrefix+"/maps-web-service/webgetlayer",this.loaded.config.url.rsc=this.options.urlPrefix+"/maps-web-service/webgetrsc",this.loaded.styles=a.styles,this.options.callback(this.loaded,!0),this.refreshStateTimeOut=setTimeout(this.wsRequestState.bind(null,this),12e5)},wsRequestState:function(a){var b={type:"StateRequest"};void 0===a?this.wsSendMessage(JSON.stringify(b)):(a.wsSendMessage(JSON.stringify(b)),a.refreshStateTimeOut=setTimeout(a.wsRequestState.bind(null,a),12e5))},wsReceivedState:function(a){if("UNI-TXT"!==a.layerCode){$(document).trigger("ws-received-state",a);var b=app.findFeatureByReceivedData(a,this.options);if(b){$(document).trigger("map-received-state",[b,a]);var c=[],d=[];$(".tooltip").remove();var e=$("."+a.layerCode).find(".panel-state-"+a.layerCode+"-"+b.getProperties().id);e&&e.empty(),a.attributes&&$.each(a.attributes,function(a,b,d){$.isArray(d)&&c.push(b+" "+d.join(" "))}.bind(this,a)),this.parseCSSClassAndGetOlStyle(c,a,"INT-INT"==a.layerCode,$.proxy(function(d){var e=this.fixRotationAndScale(b,d);b.setStyle(e),b.mappingStyle=c,b.currentState=a.attributes,b.changed()},this)),this.featureState[a.layerCode]||(this.featureState[a.layerCode]={});var f=$.grep(this.loaded.config.layers,function(b){return b.layerCode===a.layerCode})[0];d=c.map(function(a){return f.stateLabels[a]});var g=$.grep(this.loaded.config.layers,function(b){return a.layerCode===b.layerCode?b:void 0})[0];this.applyStateToDOM(c,$(".panel ."+a.layerCode+a.id+" .state-wrapper"),g.stateLabels),this.featureState[a.layerCode][a.id]=a.attributes}}},wsSendCloseMessage:function(){var a={type:"Close","cmd-id":Date.now().toString()};this.manualDisconnect=!0,this.wsSendMessage(JSON.stringify(a))},parseCSSClassAndGetOlStyle:function(a,b,c,d){var e=!1,f=$("#id"+b.id+".ol-viewport."+b.layerCode);0==f.length&&(f=$("<div/>",{id:"id"+b.id,"class":"ol-viewport "+b.layerCode}).appendTo("#ol-css-viewport"));var g;g=a.length>0?f.find("div."+a.join(".").replace(" ",".")).filter(function(){return this.className.length==a.join(" ").length}):f.find("div"),0==g.length&&(g=$("<div/>").appendTo(f),g.addClass(a.join(" ")));var h,i=window.getComputedStyle(g[0]),j={};if(b.attributes.color)h=b.attributes.color,j.fill=new ol.style.Fill({color:"rgba("+h.r+","+h.g+","+h.b+","+h.a+")"});else if("none"!=i.backgroundImage)if(c){var k,l=$("#ol-css-viewport").find("canvas");0==l.length&&(l=$("<canvas>").appendTo("#ol-css-viewport"));var m=l[0].getContext("2d"),n=new Image;n.onload=function(){var a=m.createPattern(n,"repeat");j.fill=new ol.style.Fill({color:a}),d(new ol.style.Style(j))};var o;i.backgroundImage.startsWith("url")?(o=i.backgroundImage.replace('url("',"").replace("url('",""),o=o.substring(0,o.length-2)):o=i.backgroundImage,e=!0,n.src=o}else/^url/.test(i.backgroundImage)&&(k=i.backgroundImage.replace(/^url\("/,"").replace(/"\)$/,""),j.image=new ol.style.Icon({src:k,opacity:i.opacity,rotateWithView:!0}));else if(i.backgroundColor){var p;p=/^rgba/.test(i.backgroundColor)?i.backgroundColor:i.backgroundColor.replace(/^rgb/,"rgba").replace(/\)$/,"")+", "+i.opacity+")",j.fill=new ol.style.Fill({color:p})}var q=parseFloat(i.borderWidth);if(q){var r=0;switch(i.borderStyle){case"dashed":r=[5*q,5*q];break;case"dotted":r=[q,q];break;default:r=[0]}j.stroke=new ol.style.Stroke({color:i.borderColor,width:parseInt(i.borderWidth),lineDash:r,lineCap:"butt"})}map.getLayerByLayerCode(b.layerCode).get("showLabel")&&(j.text=new ol.style.Text({font:"12px sans-serif",fill:new ol.style.Fill({color:"black"}),stroke:new ol.style.Stroke({color:"white",width:2})})),this.options.debugmode.styles&&console.log(a,j),e||d(new ol.style.Style(j))},fixRotationAndScale:function(a,b){var c=1.03,d=3;return function(a){return b.getText()&&(this.get("name")&&d>a?d>2*a?b.getText().setText(this.get("name")):b.getText().setText(this.get("name").replace(/ /g,"\n")):b.getText().setText()),b.getImage()&&(this.get("rot")&&b.getImage().setRotation(this.get("rot")),this.get("scale")&&b.getImage().setScale(this.get("scale")/a*c)),[b]}.bind(a)},findByDataAction:function(a){var b,c=app.getLayerById(a.layerCode),d=Number(a.attributes.integraId);if(c){var e=c.getSource().getFeatures();e.forEach(function(a){var c=a.getProperties();return c.hasOwnProperty("id")&&Number(c.id)===d?(b=a,a):void 0})}else console.log("Layer not found");return b},defaultStyles:function(){map.getLayers().forEach(function(a){a instanceof ol.layer.Vector&&a.getSource().getFeatures().forEach(function(a){a.setStyle(null)})})},disposeLoader:function(){$("#loader").remove()},doAction:function(a){if("url"!==$(a.target).data("actiontype")&&"mapUrl"!==$(a.target).data("actiontype")){var b={cancel:!1};$(this).trigger("map-pre-action",b),$.when(b.cancel).then($.proxy(function(b){if(!b){var c={type:"Action","cmd-id":Date.now().toString()};c.id=$(a.target).closest("ul").data("id"),c.action=$(a.target).data("action"),c.layer=$(a.target).data("layer"),c.confirm=$(a.target).data("confirm"),void 0!==this.options.actionAttributeCallback&&(c.attributes=this.options.actionAttributeCallback(c.layer,c.action,c.id)),this.wsSendMessage(JSON.stringify(c))}this.$closer.trigger("click")},this)).fail($.proxy(function(){this.$closer.trigger("click")},this))}},generateInterval:function(a){var b=1e3*(Math.pow(2,a)-1);return b>3e4&&(b=3e4),Math.random()*b},writeToReceivedBox:function(a){this.options.debugmode.websocket&&console.log("RCV:"+a)},writeToSentBox:function(a){this.options.debugmode.websocket&&console.log("SNT:"+a)},mapLink:function(a){this.popupSetPosition(void 0),$(document).trigger("ws-alert-close"),void 0===this.options.mapLinkCallback?this.mapLinkInternal(a):this.options.mapLinkCallback(a)},mapLinkInternal:function(a){this.wsMapRequest(a)},buildActionsPopup:function(a){if(!map.editMode){if($(document).trigger("ws-popup",a),a.layerConfig.hasOwnProperty("actions")){var b=$("<div>",{"class":"panel "+a.layer.get("layerCode")});a.feature.get("name")&&b.append("<div class='feature-title pull-left "+a.layer.get("layerCode")+"' data-layer_code='"+a.feature.get("layerCode")+"' data-feature_id='"+a.feature.get("id")+"'> "+a.feature.get("name")+"</div>");var c=["default","type9"],d=$(a.feature.mappingStyle).not(c).get();if(d.length){var e=$("<div/>",{"class":"state-wrapper panel-state-"+a.layer.get("layerCode")+"-"+a.feature.get("id")}).appendTo(b);this.applyStateToDOM(a.feature.mappingStyle,e,a.layerConfig.stateLabels)}var f=$("<ul/>",{"data-id":a.feature.get("id")}).appendTo(b);return WS.$content.append(b),a.layerConfig.autoOpenAction===!0&&a.featuresCount&&1===a.featuresCount?WS.actionAutoOpen(a):($.each(a.layerConfig.actions,this.buildActionsList.bind(null,f,a)),!0)}return!1}},applyStateToDOM:function(a,b,c){b.empty();var d=[];$.each(a,function(a,c,e){var f=e.split(" ")[0],g=e.split(" ");switch(f){case"users":d.push($("<div/>",{"class":f,html:'<i class="fa fa-users"></i> <span class="badge">'+g[1]+"</span>"}));break;default:var h=g.map(function(a,b,c){return c>0&&void 0!==a[f]?a[f][b]:void 0}.bind(null,a));b.append($("<div/>",{"class":e,title:h.filter(Boolean).join(", ")}))}}.bind(null,c)),d.length&&$.each(d,function(a,c){b.append(c)})},buildActionsList:function($actionList,options,i,action){var isVisible,_fcs=options.feature.currentState,_fprop=options.feature.getProperties(),visibleExpr=action.actionActiveExp.replace(/=state/g,"_fcs");visibleExpr=visibleExpr.replace(/=properties/g,"_fprop"),visibleExpr=visibleExpr.replace(/isOn\(/g,"-1<$.inArray(");try{isVisible=parseBool(eval(visibleExpr))}catch(e){isVisible=!1}if(isVisible){var link={};link.url="#","url"===action.actionType&&(""!==_fprop[action.actionCode]?link.url=_fprop[action.actionCode]:link["class"]="disabled",link.target="_blank"),"mapUrl"===action.actionType?link.url="javascript: WS.mapLink("+_fprop.id+");":null;var $actionLink=$("<a/>",{href:link.url,target:link.target,"class":link["class"],html:action.descr});$actionLink.data({actiontype:action.actionType,action:action.actionCode,layer:options.layer.get("layerCode"),confirm:action.confirm}),$actionList.append($("<li/>").append($actionLink))}},actionAutoOpen:function(a){var b=a.feature.getProperties(),c=a.layerConfig.actions[0];switch(c.actionType){case"url":window.open(b[c.actionCode],"_blank");break;case"mapUrl":WS.mapLink(b.id)}return!1}},map={},styles={},console=window.console||{},backgroupRefresh,refreshTimerFunc=function(){$.get("/ver/1",function(){backgroupRefresh=setTimeout(refreshTimerFunc,6e4)}).fail(function(){window.location.href="/logout"})},satelol3=function(){var a,b,c=([new ol.style.Style({stroke:new ol.style.Stroke({color:"#f00",width:1})})],function(a){backgroupRefresh&&clearTimeout(backgroupRefresh),backgroupRefresh=setTimeout(refreshTimerFunc,6e4);var b={uri:"ws://192.168.1.11:8080/maps-web-service/webregisterstatelistener/1/",mapLinkCallback:void 0,actionAttributeCallback:void 0,mapId:void 0,urlPrefix:"/maps",assetsPath:"assets/",showEditButton:!0,showDownloadButton:!1,debugmode:{websocket:!1,styles:!1,states:!1}};$.extend(b,a),$.loadCSS(b.urlPrefix+"/maps-web-service/webgetrsc/css/0"),WS.init({manager:this,websocketUriBase:b.uri,callback:this.mapsInit,mapLinkCallback:b.mapLinkCallback,actionAttributeCallback:b.actionAttributeCallback,mapId:b.mapId,lang:b.lang,urlPrefix:b.urlPrefix,assetsPath:b.assetsPath,debugmode:b.debugmode,token:b.token,respOkCode:b.respOkCode}),$(WS).on("map-pre-action",$.proxy(function(a,b){$(this).trigger("map-pre-action",b)},this)),this.options=b}),d=function(){var a=map.getView(),b=this.mapextent?this.mapextent:a.getProjection().getExtent(),c=map.getSize();a.fit(b,c)},e=function(a,b){var c=[],d=[],e=new ol.proj.Projection(a.config.projection);satelol3.backextent=[a.config.background.x,a.config.background.y,a.config.background.width+a.config.background.x,a.config.background.height+a.config.background.y];var f=new ol.source.ImageStatic({imageExtent:satelol3.backextent,imageSize:[a.config.background.width,a.config.background.height],url:a.config.url.json+"/"+a.config.id+"/background"});satelol3.mapextent=void 0,satelol3.layerdone=0,d.push(new ol.layer.Image({layerCode:"background",source:f,opacity:1})),$("#map-title").html(a.config.name),satelol3.layercount=a.config.layers.length,satelol3.layerdone=0,$.each(a.config.layers,function(b,f){$.loadCSS(WS.options.assetsPath+f.layerCode+"/layer.css"),f.cssUrl&&$.loadCSS(WS.options.urlPrefix+"/"+f.cssUrl);var g=new ol.source.Vector({url:a.config.url.json+"/"+a.config.id+"/"+f.layerCode,format:new ol.format.GeoJSON({defaultDataProjection:e})});g.on("change",function(){satelol3.layerdone++,satelol3.mapextent?ol.extent.extend(satelol3.mapextent,this.getExtent()):satelol3.mapextent=this.getExtent(),satelol3.layerdone===satelol3.layercount&&(ol.extent.extend(satelol3.mapextent,satelol3.backextent),satelol3.fitMap())}),g.vSourceId=b+1,c[g.vSourceId]=$.Deferred(),g.on("change",function(){"ready"===this.getState()&&c[this.vSourceId].resolve(this.vSourceId)});var h={layerCode:f.layerCode,layerName:f.layerName,showLabel:f.showLabel,source:g};"UNI-TXT"===f.layerCode&&(h.style=function(a,b){var c=a.getProperties(),d=1.03;return[new ol.style.Style({text:new ol.style.Text({font:(c.italic?"italic ":"")+(c.bold?"bold ":"")+(c.size?c.size:"10")/b*d+"px "+c.family,placement:"line",rotateWithView:!0,rotation:c.rot,fill:new ol.style.Fill({color:c.color?"rgba("+c.color.r+","+c.color.g+","+c.color.b+","+c.color.a+")":"black"}),stroke:new ol.style.Stroke({color:"white",width:2}),text:c.text})})]});var i=new ol.layer.Vector(h);d.push(i)});var g={units:"m",target:"map",controls:new ol.Collection([new ol.control.FullScreen({tipLabel:a.config.controls.fullscreen,label:$('<i class="fa fa-expand"></i>')}),new ol.control.Zoom({zoomInTipLabel:a.config.controls.zoomin,zoomOutTipLabel:a.config.controls.zoomout}),new ol.control.ZoomToExtent({tipLabel:a.config.controls.fit,label:$('<i class="fa fa-arrows-alt"></i>')}),new app.TogglePanControl,new app.RefreshControl,new app.GoUpControl]),layers:d,overlays:[WS.overlay],view:new ol.View({center:a.config.view.center,projection:e,zoom:0,maxZoom:5})};this.manager.options.showEditButton&&g.controls.push(new app.EditModeControl),this.manager.options.showDownloadButton&&g.controls.push(new app.GetEditControl({afterEdit:this.manager.options.showEditButton||!1})),b?(void 0!==$("#map .ol-viewport")&&$("#map .ol-viewport").remove(),map=new ol.Map(g),WS.wsAddPopupEvents()):map=map||new ol.Map(g),map.editMode=!1,b=!1,satelol3.fitMap();var h=function(a){var b=$("#layerFeatureInfo");b.html("<ul></ul>"),map.forEachFeatureAtPixel(a,function(a,c){a&&"UNI-TXT"!==c.get("layerCode")&&b.find("ul").append($("<li/>",{"class":c.get("layerCode"),text:a.get("name")}))})};map.forEachLayerRecursive=function(a,b){a.getLayers().forEach(function(a,c,d){b(a,c,d),a.getLayers&&ol.control.LayerSwitcher.forEachRecursive(a,b)})},map.getLayerByLayerCode=function(a){var b;return map.forEachLayerRecursive(this,function(c){return c.get("layerCode")===a?(b=c,c):void 0}),b},map.on("pointermove",function(a){if(!a.dragging){var b=map.getEventPixel(a.originalEvent);h(b)}}),map.on("click",function(b){var c=!1,d=0;WS.$content.html(""),map.forEachFeatureAtPixel(b.pixel,function(a,b){var c=b.get("layerCode");void 0!==c&&"UNI-TXT"!==c&&a&&b&&d++}),map.forEachFeatureAtPixel(b.pixel,function(b,e){if(b&&e){var f=b.get("id"),g=e.get("layerCode");if(void 0===g||"UNI-TXT"===g)return;if(WS.$content.data("id",f),1!==WS.websocket.readyState)WS.$content.html("Brak połączenia.");else{var h=$.grep(a.config.layers,function(a){return a.layerCode===g});h[0]&&(c=WS.buildActionsPopup({feature:b,layerConfig:h[0],layer:e,featuresCount:d}))}}}),c?WS.popupSetPosition(b.coordinate):WS.popupSetPosition(void 0)}),$.when.apply(this,c).done(function(){map.cachedStyles={},$("#map").css("background-color",a.config.background.color),WS.disposeLoader(),Panel.init(WS,map),WS.wsRequestState()})};return{init:c,mapsInit:e,options:a,fitMap:d,mapextent:b,backextent:void 0,layercount:void 0,layerdone:0}}();$(document).ready(function(){document.showTime?window.setInterval(function(){var a=new Date,b=("00"+a.getHours()).slice(-2)+":"+("00"+a.getMinutes()).slice(-2)+":"+("00"+a.getSeconds()).slice(-2);$("#timeInfo").html(b)},1e3):($("#timeInfo").hide(),$("#layerFeatureInfo").css("bottom","0")),$(document).on("click",".tab-controller",function(){Panel.togglePanel()}),$(document).on("click",".zoomTo",function(){var a=$(this).data("featureid"),b=$(this).data("layercode");app.zoomToFeature(a,b,!1)}),$(document).on("click",".panelPopup",function(){WS.$content.html("");var a,b=$(this).data("featureid"),c=$(this).data("layercode"),d=app.getFeature(b,c),e=map.getLayerByLayerCode(c),f=d.getGeometry();a=f instanceof ol.geom.Polygon?f.getInteriorPoint().getFirstCoordinate():f.getFirstCoordinate(),WS.buildActionsPopup({feature:d,layerConfig:$.grep(WS.loaded.config.layers,function(a){return a.layerCode===c})[0],layer:e}),app.zoomToFeature(b,c,!0),WS.popupSetPosition(a)})});var Panel={isVisible:!0,showMessage:null,hideMessage:null,animationDuration:500,animationEasing:"easeInOutCubic",init:function(a,b){$(".panel-content .content").find(".row").empty(),b.getLayers().forEach(function(a){var b=a.get("layerName"),c=a.get("layerCode");if("background"!==c){var d=$('<div class="col-md-4 col-xl-3 pl-0"><div class="panel panel-primary '+c+'">\n<div class="panel-heading"><input placeholder="'+b+'" type="search" class="form-control panel-title layerFilter" >\n<span class="layerIcon form-control-feedback" aria-hidden="true"></span>\n<input type="checkbox" class="pull-right layerToggle" data-code="'+c+'" checked="checked" /> \n</div><div class="panel-body"><div class="map-panel-body-wrapper"></div></div></div></div>');
$(".panel-content .row").append(d);var e=a.getSource().getFeatures();$.each(e,function(b,c,e){var f=a.get("layerCode"),g=e.getId(),h=$("<li class='"+f+e.getProperties().id+"'></li>").append($("<div class='panelPopupDiv'/>").append($("<a/>",{href:"#","class":"panelPopup",id:"panel-"+g,"data-attrid":e.getProperties().id,"data-featureid":g,"data-layercode":f,html:e.get("name"),title:e.get("name")}))).append($("<a/>",{href:"#","class":"zoomTo","data-attrid":e.getProperties().id,"data-featureid":g,"data-layercode":f,html:'<i class="fa fa-search"></i>'})).append($("<div/>",{"class":"state-wrapper","data-featureid":g}));d.find(".map-panel-body-wrapper").append(h)}.bind(null,this.styles[c]))}}),$(".layerFilter").addClear({symbolClass:"fa fa-times",wrapperClass:"mb-0",top:"11px",right:"16px",onClear:function(a){this.layerFilter(void 0,a)}.bind(this)}),$(".map-panel-wrapper").tooltip({selector:'[data-toggle="tooltip"]',container:"#map"}),$("body").on("keyup",".layerFilter",this.layerFilter),$("body").on("change",".layerToggle",this.layerToggle),this.hidePanel()},hidePanel:function(){$(".map-panel-wrapper").animate({bottom:-Panel.getAnimationOffset()},Panel.animationDuration,Panel.animationEasing,function(){Panel.isVisible=!1,Panel.updateTabMessage()})},showPanel:function(){$(".map-panel-wrapper").animate({bottom:0},Panel.animationDuration,Panel.animationEasing,function(){Panel.isVisible=!0,Panel.updateTabMessage()})},togglePanel:function(){(Panel.isVisible?Panel.hidePanel:Panel.showPanel)()},updateTabMessage:function(){this.isVisible?($(".tab-controller .closePanel").css("display","inline-block"),$(".tab-controller .showPanel").hide()):($(".tab-controller .closePanel").hide(),$(".tab-controller .showPanel").css("display","inline-block"))},getAnimationOffset:function(){return $(".panel-content").height()},layerToggle:function(){var a=$(this).prop("checked"),b=map.getLayerByLayerCode($(this).data("code"));b.setVisible(a)},layerFilter:function(a,b){var c=b?b:$(this),d=new RegExp(c.val(),"i");$.each(c.closest(".panel").find("li"),function(a,b){d.test($(b).text())?$(b).removeClass("hidden"):$(b).addClass("hidden")})}};