function EventsQueue(a){this.eventQueue=[],this.myEventQueue=[],this.myEvent=a|!1,this.current=-1;var b=function(a){return a.handle>0&&!(a.restore>0)};this.addEventToQueue=function(a){return this.eventQueue.push(a),Notification&&("granted"===Notification.permission||"denied"!==Notification.permission&&Notification.requestPermission(function(a){})),$(this).trigger("count-change",{my:!1,length:this.eventQueue.length}),{src:!1,evnt:a}},this.processNotification=function(a,c){"__TAKE__OVER__"===a.message?(this.removeEventFromQueue(a.id),$(document).trigger("dashboard-event-removed",a)):b(a.attributes)&&(c&&$.inArray(a.id,c)>-1?this.addEventToMyQueue(a,!0):this.addEventToQueue(a),$(document).trigger("dashboard-event-registered",a))},this.clearEventQueue=function(){this.eventQueue=[],$(this).trigger("count-change",{my:!1,length:this.eventQueue.length})},this.removeEventFromQueue=function(a){for(var b,c=this.eventQueue.length-1;c>=0;c--)this.eventQueue[c].id===a&&(b=this.eventQueue[c],this.eventQueue.splice(c,1));return $(this).trigger("count-change",{my:!1,length:this.eventQueue.length}),b},this.addEventToMyQueue=function(a,b){return this.myEventQueue.push(a),$(this).trigger("count-change",{my:!0,length:this.myEventQueue.length}),b||$(this).trigger("myevent-added",a),{src:!0,evnt:a}},this.clearMyEventQueue=function(){this.myEventQueue=[],$(this).trigger("count-change",{my:!1,length:this.eventQueue.length})},this.removeEventFromMyQueue=function(a){for(var b,c=this.myEventQueue.length-1;c>=0;c--)this.myEventQueue[c].id===a&&(b=this.myEventQueue[c],this.myEventQueue.splice(c,1));return $(this).trigger("count-change",{my:!0,length:this.myEventQueue.length}),b};var c=function(a,b,c){for(var d=0,e=a.length;e>d;d++)if(a[d].id===b)return c>0?d+1==e?void 0:a[d+1]:0>c?0>d-1?void 0:a[d-1]:a[d];return void 0};this.reset=function(a){this.current=-1,void 0!=a&&(this.myEvent=a)},this.resetBack=function(a){void 0!=a&&(this.myEvent=a);var b=this.myEvent?this.myEventQueue:this.eventQueue;b.length>0&&(this.current=b[b.length-1].id)},this.get=function(){var a=this.myEvent?this.myEventQueue:this.eventQueue,b=this.myEvent?this.eventQueue:this.myEventQueue;if(this.current<0){var d=a[0];return d?(this.current=d.id,{src:this.myEvent,evnt:d}):void 0}return d=c(a,this.current),d?(this.current=d.id,{src:this.myEvent,evnt:d}):(d=c(b,this.current),d?(this.myEvent=!this.myEvent,this.current=d.id,{src:this.myEvent,evnt:d}):void 0)},this.next=function(a){var b=this.myEvent&&!a?this.myEventQueue:this.eventQueue,d=!this.myEvent||a?this.myEventQueue:this.eventQueue;if(this.current<0)return this.get(this.myEvent);var e=c(b,this.current,1);return e?(this.current=e.id,{src:this.myEvent,evnt:e}):(d.length>0?this.reset(!this.myEvent):this.reset(),this.get())},this.prev=function(a){var b=this.myEvent&&!a?this.myEventQueue:this.eventQueue,d=!this.myEvent||a?this.myEventQueue:this.eventQueue;if(this.current<0)return this.get(this.myEvent);var e=c(b,this.current,-1);return e?(this.current=e.id,{src:this.myEvent,evnt:e}):(d.length>0?this.resetBack(!this.myEvent):this.resetBack(),this.get())}}function EventDialog(a){this.$dialog=void 0,this.dialogName=a.name,a.queue&&(this.$q=a.queue,$(document).on("dashboard-event-registered",$.proxy(function(a,b){if(this.handleEvent(a),this.$dialog){var c=this.$dialog.options.data.evnt;if(void 0===c)return;c.attributes.systemId==b.attributes.systemId&&c.attributes.idPartition==b.attributes.idPartition&&$("#ev-clear-alarm-chk").removeAttr("checked")}},this)),$(document).on("dashboard-event-removed",$.proxy(function(a,b){this.$dialog&&b.id===this.$dialog.options.data.evnt.id&&(this.$dialog.options.data.takeover||($("#comment-event-btn").removeClass("hidden"),this.$dialog.close()))},this))),this.hideSleepOption=a.hideSleepOption||!1,this.closable=a.closable||!1;var b={Comment:$('input[name="trans-comment"]').val()||"trans-comment",CommentNext:$('input[name="trans-comment-next"]').val(),CommentClose:$('input[name="trans-comment-close"]').val(),CommentCloseHandling:$('input[name="trans-comment-close-handling"]').val(),CommentConfirm:$('input[name="trans-comment-confirm"]').val(),CommentConfirmYes:$('input[name="trans-comment-confirm-yes"]').val(),CommentConfirmNo:$('input[name="trans-comment-confirm-no"]').val(),CommentDefaultMessage:$('input[name="trans-comment-default"]').val(),CommentAdd:$('input[name="trans-comment-add"]').val(),CommentDelay:$('input[name="trans-comment-delay"]').val(),CommentDate:$('input[name="trans-comment-date"]').val(),CommentOperator:$('input[name="trans-comment-operator"]').val(),CommentDescr:$('input[name="trans-comment-descr"]').val(),CommentDescrAdd:$('input[name="trans-comment-descr-add"]').val(),CommentClearAlarm:$('input[name="trans-comment-clear-alarm"]').val(),CommentDisarm:$('input[name="trans-comment-disarm"]').val()},c=function(a,c,d){var e='<div style="max-height:65vh;overflow:auto"><table class="table table-bordered table-condensed table-striped">';return a&&(e+='<tr><th class="col-md-4">'+b.CommentDate+'</th><th class="col-md-6">'+b.CommentDescr+'</th><th class="col-md-2">'+b.CommentOperator+"</th></tr>",$.each(a,function(a,b){e+='<tr><td class="col-md-4">'+b.date+'</td><td class="col-md-6"><div style="max-height:80px;max-width:280px;overflow:auto">'+b.comment+'</div></td><td class="col-md-2"><a target="blank" href="../users/'+b.idUser+'/edit">'+b.userName+"</a></td></tr>"})),e+='<tr><td class="col-md-'+(a?4:2)+'" style="text-align:right;vertical-align:top !important;">'+b.CommentDescrAdd+"</td><td "+(a?'colspan="2" ':"")+'class="col-md-'+(a?8:10)+'"><textarea id="ev-comment" maxlength="2500" style="resize: none;width:100%"></textarea><br><div  id="ev-clear-alarm" style="display:'+(c?"block":"none")+';" ><input id="ev-clear-alarm-chk" type="checkbox"'+(d?' checked="checked"':"")+"> "+b.CommentClearAlarm+'</input>&nbsp;&nbsp;<input id="ev-disarm-chk" type="checkbox"> '+b.CommentDisarm+"</div></td></tr>",e+="</table></div>"},d=function(a){return localStorage?localStorage.getItem(a):null},e=function(a,b){localStorage.setItem(a,b)},f=function(a){var b=a.message+"<div class='pull-right'>"+a.date+"</div><br>"+(a.attributes.detail?a.attributes.detail:"<br/>");return a.attributes.idZone?b+="<div class='pull-right'><input class='dialog-map-autolocate' type='checkbox' "+("true"===d("ev-comment-autozoom")?"checked":"")+"></input><div class='btn dialog-map-locate' data-layercode='INT-ZON' data-attrid='"+a.attributes.idZone+"'><i class='fa fa-map-o'></i></div></div>":a.attributes.idPartition&&(b+="<div class='pull-right'><input class='dialog-map-autolocate' type='checkbox' "+("true"===d("ev-comment-autozoom")?"checked":"")+"></input><div class='btn dialog-map-locate' data-layercode='INT-PART' data-attrid='"+a.attributes.idPartition+"'><i class='fa fa-map-o'></i></div></div>"),b};this.zoomToEvent=function(a){a.attributes.idZone?this.zoomTo("INT-ZON",a.attributes.idZone):a.attributes.idPartition&&this.zoomTo("INT-PART",a.attributes.idPartition)};var g=function(a,b,d){return'<a target="blank" href="../control/structure/'+b.attributes.systemId+'/">'+b.attributes.systemName+"</a><br>\n\n"+(d?c(b.attributes.comments,!a.hideSleepOption&&i(b.attributes)&&b.attributes.hasOwnProperty("idPartition"),1==h(a.$q,b.attributes.systemId,b.attributes.idPartition)):"")},h=function(a,b,c){return void 0===a?0:$.grep(a.eventQueue,function(a){return a.attributes.systemId==b&&a.attributes.idPartition==c?a:void 0}).length+$.grep(a.myEventQueue,function(a){return a.attributes.systemId==b&&a.attributes.idPartition==c?a:void 0}).length},i=function(a){return 1==a["class"]||0==a["class"]};this.zoomTo=function(a,b){$('a.zoomTo[data-layercode="'+a+'"][data-attrid="'+b+'"]').trigger("click")},this.enableComment=function(a,b){var c=b.evnt;myEvent=b.src,a.options.data.takeover=!0;var d=a.getButton("control-event-btn");a.setMessage(g(this,c,!0)),d.addClass("hidden"),a.getButton("comment-event-btn").removeClass("hidden"),a.getButton("sleep-event-btn").removeClass("hidden"),a.getButton("comment-event-btn").enable(),a.getButton("sleep-event-btn").enable(),a.getModalBody().find("#ev-comment").focus(),this.$q.removeEventFromQueue(a.options.data.evnt.id);var e=this.$q.addEventToMyQueue(c);e.takeover=!0,a.options.data=e,this.$q.reset(!1),this.eventTakeOver(b)},this.addComment=function(a){var b=a.getModalBody().find("#ev-comment").val();if(b)if(b=b.replace(/(\r\n|\n|\r)/gm,""),b&&b.length>0){this.addEventComment(a.options.data,b);var c;$("#ev-disarm-chk").is(":visible")&&$("#ev-disarm-chk").is(":checked")&&(c={type:"Action","cmd-id":Date.now().toString(),action:"disarm",layer:"INT-PART",confirm:!1},c.id=a.options.data.evnt.attributes.idPartition,WS.wsSendMessage(JSON.stringify(c))),$("#ev-clear-alarm-chk").is(":visible")&&$("#ev-clear-alarm-chk").is(":checked")&&(c={type:"Action","cmd-id":Date.now().toString(),action:"clearAlarm",layer:"INT-PART",confirm:!1},c.id=a.options.data.evnt.attributes.idPartition,WS.wsSendMessage(JSON.stringify(c))),a.close(),this.$q&&this.$q.removeEventFromMyQueue(a.options.data.evnt.id)}else a.getModalBody().find("#ev-comment").focus()},this.nextComment=function(){this.showEventDialog(this.$q.next())},this.prevComment=function(){this.showEventDialog(this.$q.prev())},this.showMyEventDialog=function(){this.$q.reset(!0),this.showEventDialog()},this.showAllEventDialog=function(){this.$q.reset(!1),this.showEventDialog()},this.showCommentEventDialog=function(a){this.showEventDialog(a?{src:!0,evnt:a}:void 0)},this.showEventDialog=function(a){var c=a?a:this.$q.get();if(void 0!==c){var d,h=c.evnt,i=c.src;switch(h.attributes["class"]){case 0:case 1:d=BootstrapDialog.TYPE_DANGER;break;case 5:d=BootstrapDialog.TYPE_WARNING;break;default:d=null}d||(d=BootstrapDialog.TYPE_INFO),this.$dialog?(this.$dialog.options.data=c,this.$dialog.setType(d),this.$dialog.setTitle(f(h)),this.$dialog.setMessage(g(this,h,h.attributes.comments||i))):(this.$dialog=BootstrapDialog.show({id:this.dialogName,animate:!0,type:d,closable:this.closable,css:"eventDialogMessage",data:c,draggable:!0,buttons:[{id:"close-event-btn",cssClass:"pull-left",label:this.hideSleepOption?b.CommentClose:b.CommentCloseHandling,action:$.proxy(function(){this.hideSleepOption?this.$dialog.close():BootstrapDialog.show({animate:!1,type:BootstrapDialog.TYPE_DANGER,title:b.CommentClose,message:b.CommentConfirm,closable:!1,buttons:[{label:b.CommentConfirmYes,action:$.proxy(function(a){var c=this.$dialog.options.data;this.eventTakeOver(c),this.addEventComment(c,b.CommentDefaultMessage),c.src?this.$q.removeEventFromMyQueue(c.evnt.id):this.$q.removeEventFromQueue(c.evnt.id),$("#comment-event-btn").removeClass("hidden"),this.$dialog.close(),a.close()},this)},{label:b.CommentConfirmNo,action:function(a){a.close()}}]})},this)},{id:"prev-event-btn",label:"<",cssClass:"btn-default pull-left"+(void 0==this.$q?" hidden":""),action:$.proxy(function(a){this.prevComment(a)},this)},{id:"next-event-btn",label:">",cssClass:"btn-default pull-left"+(void 0==this.$q?" hidden":""),action:$.proxy(function(a){this.nextComment(a)},this)},{id:"control-event-btn",label:b.Comment,cssClass:"btn-info"+(i?" hidden":""),action:$.proxy(function(a){this.enableComment(a,this.$q.get())},this)},{id:"comment-event-btn",label:b.CommentAdd,cssClass:i?"btn-info":"btn-info hidden",action:$.proxy(function(a){this.addComment(a)},this)},{id:"sleep-event-btn",label:b.CommentDelay,cssClass:i&&!this.hideSleepOption?"":"hidden",action:function(a){a.close()}}],title:f(h),message:g(this,h,h.attributes.comments||i),onhidden:$.proxy(function(){var a=this.$dialog.options.data;if(this.$dialog=void 0,this.$q){var b=this.$q.next(!0);b&&b.evnt.id!=a.id&&this.showEventDialog(b)}},this)}),this.$dialog.getModal().on("keyup",{dialog:this.$dialog,obj:this},function(a){var b=a.data.dialog,c=a.data.obj;if(13==a.which){var d=b.getButton("control-event-btn"),e=b.getButton("comment-event-btn"),f=!(d.prop("disabled")||d.hasClass("hidden")),g=!(e.prop("disabled")||e.hasClass("hidden"));f&&d.focus().trigger("click"),g&&e.focus().trigger("click")}else a.ctrlKey&&(188==a.which?c.prevComment(b):190==a.which&&c.nextComment(b))}),this.$dialog.getModal().on("mouseup",{dialogObj:this},function(a){var b=a.data.dialogObj;b.position=b.$dialog.$modalDialog.position(),$("div.bootstrap-dialog-resetpos-button").css({color:b.position.left==b.position.top&&0==b.position.top?"black":"red"})})),this.$dialog.getModal().on("click","div.bootstrap-dialog-resetpos-button",$.proxy(function(){this.$dialog.getModalDialog().css({left:0,top:0}),$("div.bootstrap-dialog-resetpos-button").css({color:"black"})},this)),this.$dialog.getModal().on("click","div.dialog-map-locate",$.proxy(function(a){var b=$(a.currentTarget);this.zoomTo(b.data("layercode"),b.data("attrid"))},this)),this.$dialog.getModal().on("click","input.dialog-map-autolocate",$.proxy(function(){e("ev-comment-autozoom",$(".dialog-map-autolocate").is(":checked"))},this));var j=this.$dialog.getButton("next-event-btn");j.toggleEnable(void 0!=this.$q),this.$dialog.isOpened()||this.$dialog.open(),i?(this.$dialog.getButton("control-event-btn").addClass("hidden"),this.$dialog.getButton("sleep-event-btn").removeClass("hidden"),this.$dialog.getButton("comment-event-btn").removeClass("hidden")):(this.$dialog.getButton("control-event-btn").removeClass("hidden"),this.$dialog.getButton("sleep-event-btn").addClass("hidden"),this.$dialog.getButton("comment-event-btn").addClass("hidden")),this.$dialog.getModal().on("shown.bs.modal",{dialog:this.$dialog,obj:this},function(a){var b=a.data.dialog,c=a.data.obj;b.getModalBody().find("#ev-comment").length>0&&b.getModalBody().find("#ev-comment").is(":visible")&&b.getModalBody().find("#ev-comment").focus(),$('<div class="bootstrap-dialog-resetpos-button"><i class="fa fa-thumb-tack"></i></div>').insertAfter($(".bootstrap-dialog-close-button")),c.position&&(b.getModalDialog().css(c.position),$("div.bootstrap-dialog-resetpos-button").css({color:c.position.left==c.position.top&&0==c.position.top?"black":"red"})),$(".dialog-map-autolocate").length>0&&$(".dialog-map-autolocate").is(":checked")&&c.zoomToEvent(h)}),$(".dialog-map-autolocate").length>0&&$(".dialog-map-autolocate").is(":checked")&&this.zoomToEvent(h),i&&(this.$dialog.options.data.takeover=!0)}},this.eventTakeOver=function(a){var b=a.evnt;WS.wsSendMessage(JSON.stringify({type:"Action",action:"ev-take-over",layer:"INT-INT","cmd-id":Date.now().toString(),id:b.id,attributes:{hierarchyQuery:b.hierarchyQuery,date:b.date}}))},this.addEventComment=function(a,b){$.post("/event/comments",{_token:$("input[name=_token]").val(),id:a.evnt.id,comment:b},function(){$(document).trigger("ev-comment-added",a.evnt.id)}).fail(function(a){0!==a.readyState&&(window.location.href="/logout")})},this.handleEvent=function(){void 0!==this.$dialog&&this.$dialog.opened||this.showAllEventDialog()}}function DashboardEvents(a){if(this.limitEvent=a.limitEvent,this.timeElement=".event-refresh-interval",this.intervals=[.5,1,3,5,10,0],document.integrumEventShowDialog){if(this.queue=new EventsQueue(!0),Notification){var b=Notification.requestPermission();b&&b.then(function(a){console.log(a)})}$(document).on("ws-notification",$.proxy(function(a,b){"INT-EV"===b.layerCode&&this.queue.processNotification(b)},this)),$(this.queue).on("count-change",function(a){$("#myEventCountBadgeCount").html(a.currentTarget.myEventQueue.length),$("#eventCountBadgeCount").html(a.currentTarget.eventQueue.length)}),$(this.queue).on("myevent-added",function(a,b){$.ajaxQueue({url:"dashboard/events/"+b.id+"/myqueue/added",success:function(){}})});var c=this;$.ajaxQueue({dataType:"json",url:"dashboard/events/unhandled",success:function(a){$.each(a.evnt,function(a,b,d){c.queue.processNotification(d,a.my)}.bind("result",a))}})}else this.queue=void 0;this.eventDialog=new EventDialog({name:"qEvDialog",queue:this.queue}),this.commentDialog=new EventDialog({name:"commentEvDialog",hideSleepOption:!0,closable:!0}),this.hierarchytree=void 0,this.objDashboard=void 0,this.eventsPanels=[],this.lastexec=0,this.finished=!0,this.interval=3e4,$(document).on("click",this.timeElement,$.proxy(function(a){const b=$(this.timeElement);var c=(b.data("idx")+1)%this.intervals.length;try{this.interval=1e3*(60*this.intervals[c])}catch(a){this.interval=3e4,c=0}b.html(this.intervals[c]),b.data("idx",c)},this)),this.init=function(a){this.objDashboard=a;var b=$(".dashboard-event").toArray();for(this.eventsPanels=[],i=0;i<b.length;i++)this.eventsPanels.push($(b[i]).data("type"));this.currentPanel=0,setInterval($.proxy(function(){const a=(new Date).getTime();this.interval>0&&this.finished&&a-this.lastexec>this.interval&&(this.finished=!1,this.getEventDashBoard(this.eventsPanels[this.currentPanel++%this.eventsPanels.length],this.hierarchytree),this.lastexec=a)},this),1e4)},this.getEventDashBoard=function(a,b){var c=$('.dashboard-event[data-type="'+a+'"]');$.ajaxQueue({dataType:"json",url:"/dashboard/events/"+a+"/"+b,error:$.proxy(function(a){this.finished=!0},this),success:$.proxy(function(a){this.finished=!0,c.empty();var b=a.eventList;if(a.eventList){var d=0,e=this;$(b).each(function(a,b){if(d++>e.limitEvent)return!1;var f=b.date.split(".");c.append('<tr data-systemid="'+b.systemId+'"><td style="min-width:7em"> '+f[1]+"."+f[2]+" </td><td> "+b.description+" </td><td> "+b.type+" "+(document.integrumEventShowComments?e.getCommentIcon(b.id,b.commentCount):"")+" </td><td> "+b.user+" </td></tr>")}),c.find("tr").css("cursor","pointer")}else c.empty(),c.append("<tr><td> brak danych  </td> <td> null </td><td> null </td><td> null </td><td> null </td></tr>")},this)})},this.loaddata=function(a){this.hierarchytree=a.id,$(".dashboard-event").each($.proxy(function(a,b){this.getEventDashBoard($(b).data("type"),this.hierarchytree)},this))},this.getCommentIcon=function(a,b){return parseInt(b)>0?'<span class="editEvent label label-default" data-event-id="'+a+'" ><i class="far fa-lg fa-comment"></i> <span class="commentCount">'+b+"</span></span>":'<span class="addEvent label label-default-light" data-event-id="'+a+'"><i class="far fa-comment"></i> <i class="fa fa-plus"></i></span> '},this.getCommentCount=function(a){var b=$('span[data-event-id="'+a+'"] > span.commentCount').html();return b?parseInt(b):0},this.setCommentCount=function(a,b){b>1?$('span[data-event-id="'+a+'"] > span.commentCount').html(b):($('span[data-event-id="'+a+'"]').html('<i class="far fa-lg fa-comment"></i> <span class="commentCount">'+b+"</span></span>"),$('span[data-event-id="'+a+'"]').removeClass("label-default-light addEvent").addClass("editEvent label-default"))}}function parseBool(a){return!/^(false|0)$/i.test(a)&&!!a}!function(a){var b=a({});a.ajaxQueue=function(c){function d(b){e=a.ajax(c).done(f.resolve).fail(f.reject).then(b,b)}var e,f=a.Deferred(),g=f.promise();return b.queue(d),g.abort=function(h){if(e)return e.abort(h);var i=b.queue(),j=a.inArray(d,i);return j>-1&&i.splice(j,1),f.rejectWith(c.context||c,[g,h,""]),g},g}}(jQuery);var integrumDash={objects:[],hierarchytree:1,initdata:void 0,register:function(a,b){0>b?integrumDash.objects.push(a):integrumDash.objects.unshift(a),this.initdata&&a.init(this.initdata)},init:function(a){this.initdata=a;for(var b=0;b<this.objects.length;++b)this.objects[b].init($(this),a);this.getHierarchy(),$(document).on("tree-selected",function(){integrumDash.getHierarchy()})},loaddata:function(a){for(var b=0;b<this.objects.length;++b)this.objects[b].loaddata(a)},getHierarchy:function(){var a=getCurrentRegionHierarchy(),b=a.id;null!=b&&integrumDash.loaddata(a)}};jQuery(document).ready(function(a){a(".navbar-fixed-top").css("margin-top","-50px"),a("#ds-a-menu").click(function(){return"active"!=a("#navbar-backdrop").attr("class")?(a(".navbar-fixed-top").animate({marginTop:"0px"},500),a("#navbar-arrow-dropdown").hide(),a("#navbar-backdrop").addClass("active"),!1):void 0}),a("#navbar-backdrop").click(function(){return a(".navbar-fixed-top").animate({marginTop:"-50px"},500),a("#navbar-arrow-dropdown").show(),a("#navbar-backdrop").removeClass(),!1}),a('[data-toggle="tooltip"]').tooltip(),a(document).on("map-received-state",function(b,c,d){d.hasOwnProperty("attributes")&&a.each(d.attributes,function(b,c){for(var e in c){var f=a("audio.state."+b+"-"+c[e]+'[data-layer="'+d.layerCode+'"]');f.length>0&&f[0].play()}})})}),jQuery(document).ready(function(a){function b(a){f(a)}function c(c){a.ajaxQueue({dataType:"json",url:"/websocket/options",success:function(c){var d=c.mapoptions,e=g();h={uri:e+"://"+d.uri+"/maps-web-service/webregisterstatelistener/1/",mapLinkCallback:b,urlPrefix:a(window.location).attr("protocol")+"//"+d.uri,assetsPath:"/assets/",showEditButton:!1,showDownloadButton:a("#permMapEdit").val(),token:c.token,lang:c.lang||navigator.language||navigator.userLanguage,respOkCode:"1"}}}).done(function(){f(c)})}function d(c){a.ajaxQueue({dataType:"json",url:"/websocket/options",success:function(c){var d=a(window.location).attr("host"),e=g();h={uri:e+"://"+d+"/maps/maps-web-service/webregisterstatelistener/1/",mapLinkCallback:b,urlPrefix:"/maps",assetsPath:"/assets/",showEditButton:!1,showDownloadButton:a("#permMapEdit").val(),token:c.token,lang:c.lang||navigator.language||navigator.userLanguage,respOkCode:"1"}}}).done(function(){f(c)})}function e(){var b=a.Deferred(),c=a('<div class="centered"></div>');return c.append("Podaj hasło:<br />"),c.append('<input class="form-control marginb-10" type="password" id="dialog-password"/><div class="alert alert-danger" role="alert" id="dialog-error" style="display:none;">Niepoprawne hasło!</div>'),BootstrapDialog.show({title:"Potwierdź",type:BootstrapDialog.TYPE_WARNING,message:c,closable:!1,onshown:function(a){a.$modal.find("#dialog-password")[0].focus()},buttons:[{label:"Anuluj",hotkey:27,action:function(a){a.close(),b.resolve(!0)}},{label:"OK",hotkey:13,cssClass:"btn-primary",action:function(c){var d=this;c.$modal.find("#dialog-error").hide();var e={pwd:c.$modal.find("#dialog-password").val()};d.spin(),a.post("logincheck",e,function(a){d.stopSpin(),a.ret?(b.resolve(!1),c.close()):(c.$modal.find("#dialog-error").show(),c.$modal.find("#dialog-password")[0].focus())},"json").fail(function(){d.stopSpin(),b.reject(),c.close()})}}]}),b.promise()}function f(b){var c=h;c.mapId=b,satelol3.init(c),i||(a(document).on("ws-alert",a.proxy(function(a,b){this.$dialog=BootstrapDialog.show({id:"map-message",title:"string"==typeof b?"Info":b[0],message:"string"==typeof b?b:b[1]})},this)),a(document).on("ws-alert-close",a.proxy(function(){this.$dialog&&(this.$dialog.close(),this.$dialog=void 0)},this)),a(document).on("feature-title-click",a.proxy(function(a,b){switch(b.layer_code){case"INT-INT":window.open("control/structure/"+b.feature_id,"integrum")}},this)),i=!0)}function g(){var b="ws";return"https:"===a(window.location).attr("protocol")&&(b="wss"),b}var h,i,j={loaddata:function(b){var e=b.id,f=a(window.location).attr("port");"81x"===f?c("h"+e):d("h"+e)},objDashboard:void 0,init:function(a){this.objDashboard=a}};a(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",function(){satelol3.fitMap()}),a("#permExtraAuth").val()&&a(satelol3).on("map-pre-action",function(a,b){b.cancel=e()}),integrumDash.register(j)}),jQuery(document).ready(function(a){function b(b){a(".dashboard-detail").hide(),a('.dashboard-detail[data-type="'+b+'"]').show()}function c(){setControlInfo(e,f)}var d={loaddata:function(){},objDashboard:void 0,init:function(a){this.objDashboard=a}};b("start"),a("#detail-refresh-link").click(function(){c()}),a(integrumDash).on("idash-setControlInfo",function(c,g,h){e=g,f=h,b(g),a.getJSON("/dashboard/detail/".concat(g,"/",h),function(a){d.objDashboard.trigger("idash-setControlDetail",[a.system,a.parameters])})});var e,f;integrumDash.register(d)});var integrumDashPropList={limitEvent:140,hierarchytree:void 0,loaddata:function(a){this.hierarchytree=a.id},showDetail:function(a){this.objDashboard.trigger("idash-setControlInfo",[this.currentDashboardListSystem,a])},objDashboard:void 0,prevLvl:void 0,getPrevManual:function(){return"rgb(255, 0, 0)"==$("#detaillist-prevent-refresh-link").css("color")},setPrevManual:function(a){$("#detaillist-prevent-refresh-link").css("color",a?"rgb(255, 0, 0)":"inherit")},init:function(a){this.objDashboard=a,this.showProperties("start"),a.on("idash-setControlList",function(a,b,c,d,e,f){(f||void 0===integrumDashPropList.prevLvl||integrumDashPropList.prevLvl>e&&!integrumDashPropList.getPrevManual())&&(integrumDashPropList.setControlList(b,c,d),integrumDashPropList.prevLvl=e,integrumDashPropList.setPrevManual(f))})},showProperties:function(a){$(".dashboard-detail").hide(),$('.dashboard-detail[data-type="'+a+'"]').show()},refreshDetailList:function(){this.setControlList(this.currentDashboardListName,this.currentDashboardListSystem,this.currentDashboardListCode)},currentDashboardListName:void 0,currentDashboardListSystem:void 0,currentDashboardListCode:void 0,setControlList:function(a,b,c){this.showProperties("list"),this.currentDashboardListName=a,this.currentDashboardListSystem=b,this.currentDashboardListCode=c,$.ajaxQueue({type:"get",url:"/dashboard/filter/".concat(b,"/",c,"/",this.hierarchytree),data:"",system:b,name:a,objDashboard:this.objDashboard,success:function(a){$("#integraTable").empty(),$("#control-list-db-name").text(this.name),this.objDashboard.trigger("idash-detail-list",[this.system,a])},dataType:"json",error:function(a,b,c){console.log(b,c),$(window.location).attr("href","logout")}})}};jQuery(document).ready(function(a){a("#detaillist-refresh-link").click(function(){integrumDashPropList.refreshDetailList()}),a("#detaillist-prevent-refresh-link").click(function(){integrumDashPropList.setPrevManual(!integrumDashPropList.getPrevManual())}),a("#integraTable").on("click","a",function(){a(this).data("idmaps")&&mapLinkClicked(a(this).data("idmaps")),a(this).data("id")&&integrumDashPropList.showDetail(a(this).data("id"))}),integrumDash.register(integrumDashPropList)}),jQuery(document).ready(function(a){a(integrumDash).on("idash-setControlDetail",function(b,c,d){if("csp"===c){var e={1:"",2:"outlined",3:"blink"},f="outlined";1!=d.parameters.online&&(f=""),a("#csp-control-db-name").text(d.parameters.name),a("#csp-control-db-type").html("CSP-20".concat(d.parameters.type)),a("#csp-control-db-level").html(d.parameters.level),a("#csp-diode-fire").removeClass(),a("#csp-diode-trouble").removeClass(),a("#csp-diode-blocked").removeClass(),a("#csp-diode-test").removeClass(),a("#csp-diode-delay").removeClass(),a("#csp-diode-offline").removeClass(),a("#csp-diode-txfire").removeClass(),a("#csp-diode-txfault").removeClass(),a("#csp-diode-powerfault").removeClass(),a("#csp-diode-auxfault").removeClass(),a("#csp-diode-systemfault").removeClass(),a("#csp-diode-silenced").removeClass(),a("#csp-diode-fire").addClass("diode red "+e[d.parameters.alarm]),a("#csp-diode-trouble").addClass("diode yellow "+e[d.parameters.trouble]),a("#csp-diode-blocked").addClass("diode yellow "+e[d.parameters.blocked]),a("#csp-diode-test").addClass("diode yellow "+e[d.parameters.test]),a("#csp-diode-delay").addClass("diode green4 "+e[d.parameters.delayed]),a("#csp-diode-offline").addClass("diode red "+f),a("#csp-diode-txfire").addClass("diode red "+e[d.parameters.txFire]),a("#csp-diode-txfault").addClass("diode yellow "+e[d.parameters.txFault]),a("#csp-diode-powerfault").addClass("diode yellow "+e[d.parameters.power]),a("#csp-diode-auxfault").addClass("diode yellow "+e[d.parameters.auxTrouble]),a("#csp-diode-systemfault").addClass("diode yellow "+e[d.parameters.systemTrouble]),a("#csp-diode-silenced").addClass("diode red "+e[d.parameters.silenced])}}),a(integrumDash).on("idash-detail-list",function(b,c,d){if("csp"===c){var e={1:"",2:"outlined",3:"blink"};a(d).each(function(b,c){var d="No ETH";c.ip&&(d=c.ip+":"+c.port);var f="outlined";1!=c.statusCode.connection&&(f="");var g="";c.mapId&&(g='<a href="#" data-idmaps="'+c.mapId+'" class="btn btn-default btn-xs" role="button"><i class="fa fa-map-o"></i></a>'),a("#integraTable").append('<tr data-value="'+c.id+'"><td> </td><td></td>\n                                        <td><a href="#" data-id="'+c.id+'" role="button" >'+c.name+"</a></th>\n                                        <td>"+d+'</td>\n                                        <td><div class="diode red '+e[c.statusCode.alarm]+'"></div></td>\n                                        <td><div class="diode yellow '+e[c.statusCode.trouble]+'"></div></td>\n                                        <td><div class="diode yellow '+e[c.statusCode.blocked]+'"></div></td>\n                                        <td><div class="diode yellow '+e[c.statusCode.test]+'"></div></td>\n                                        <td><div class="diode green '+e[c.statusCode.delayed]+'"></div></td>\n                                        <td><div class="diode red '+f+'"></div></td>\n                                        <td> </td><td></td><td>'+g+"</td>\n                                        </tr>")})}})}),jQuery(document).ready(function(a){a(integrumDash).on("idash-setControlDetail",function(b,c,d){if("integra"===c){var e={1:"",2:"outlined",3:"blink"},f={0:"",1:"green blink",2:"red",3:"yellow"},g=JSON.parse(d.state);a("#control-db-name").text(d.name),a("#control-db-type").html(d.integraType),a("#control-db-version").html(d.version),a("#a-db-structure").attr("href","control/structure/"+d.id),a("#diode-1").removeClass(),a("#diode-2").removeClass(),a("#diode-3").removeClass(),a("#diode-4").removeClass(),a("#diode-5").removeClass(),a("#diode-1").addClass("diode red "+e[g[0].value]),a("#diode-2").addClass("diode yellow "+e[g[1].value]),a("#diode-3").addClass("diode green "+e[g[2].value]),a("#diode-4").addClass("diode green4 "+e[g[3].value]),a("#diode-5").addClass("diode "+f[g[4].value])}}),a(integrumDash).on("idash-detail-list",function(b,c,d){if("integra"===c){a("#integraTable").empty(),a("#integraTable").append('<tr><td> </td><td></td>\n							<td></td><td></td>\n							<td><div class="fa fa-bell"  style="float:right"></div></td>\n							<td ><div class="fa fa-exclamation-triangle" style="float:right"></div></td>\n							<td ><div class="fa fa-eye" style="float:right"></div></td>\n							<td ><div class="fa fa-wrench" style="float:right"></div></td>\n							<td ><div class="fa fa-globe-africa" style="float:right"></td><td></td>\n							<td><div class="fa fa-map-hidden" style="float:right"></td><td></td><td></td>\n							</tr>');var e=0;a(d).each(function(b,c){function d(a,b,c,d){var e=c||f;return a.hasOwnProperty(b)?e[a[b]]:d||2}var f={1:"",2:"outlined",3:"blink"},g={0:"yellow",1:"red",2:"red outlined",3:"green blink"};if(e++>this.limitEvent)return!1;var h="No ETHM";c.ip&&(h=c.ip+":"+c.port);var i="";c.mapId&&(i='<a href="#" data-idmaps="'+c.mapId+'" class="btn btn-default btn-xs" role="button"><i class="fa fa-map-o"></i></a>'),a("#integraTable").append('<tr data-value="'+c.id+'"><td> </td><td></td>\n								<td><a href="#" data-id="'+c.id+'" role="button" >'+c.name+"</td><td>"+h+'</td>\n								<td><div class="diode red '+d(c.statusCode,"alarm")+'"></div></td>\n								<td><div class="diode yellow '+d(c.statusCode,"trouble")+'"></div></td>\n								<td><div class="diode green '+d(c.statusCode,"arm")+'"></div></td>\n								<td><div class="diode green2 '+d(c.statusCode,"service")+'"></div></td>\n								<td><div class="diode '+d(c.statusCode,"connection",g,1)+'"></td><td></td>\n                                <td> </td><td></td><td>'+i+"</td>\n								</tr>")})}})});var integrumDashEvents=new DashboardEvents({limitEvent:140});jQuery(document).ready(function(a){function b(b,c){var d=a(b.currentTarget).data("eventId");a.get("/event/"+d,a.proxy(function(a){this.commentDialog.showCommentEventDialog(a)},c),"json").fail(function(a){0!==a.readyState&&(window.location.href="/logout")})}a(".dashboard-event-head").hide(),a(".dashboard-event-refresh").click(function(){integrumDashEvents.getEventDashBoard(a(this).data("type"),integrumDashEvents.hierarchytree)}),a(".dashboard-event").on("click","tr",function(){
var b=a(this).data("systemid").split(":");integrumDashEvents.objDashboard.trigger("idash-setControlInfo",[b[0],b[1]])}),a("#myEventCountBadge").on("click",function(){integrumDashEvents.eventDialog.showMyEventDialog()}),a("#eventCountBadge").on("click",function(){integrumDashEvents.eventDialog.showAllEventDialog()}),a(document).on("click",".editEvent",function(a){b(a,integrumDashEvents)}),a(document).on("click",".addEvent",function(a){b(a,integrumDashEvents)}),a(document).on("ev-comment-added",function(a,b){integrumDashEvents.setCommentCount(b,integrumDashEvents.getCommentCount(b)+1)}),integrumDash.register(integrumDashEvents,-1)});var integrumDashOverall={DATA_INTERVAL:10,CHART_INTERVAL:30,HISTORY_LENGTH:30,morrisAreaData:[],ykeys:[],hierarchytree:void 0,loaddata:function(a){this.hierarchytree=a.id,$("#properties h3.panel-title span#name").html("INTEGRUM ["+a.name+"]"),this.refresh(this.objDashboard,this.initData),this.setIntegrumAreaChart(!0),this.getOverallstate()},objDashboard:void 0,initData:void 0,eventArchive:0,lastexec:0,finished:!0,init:function(a,b){this.objDashboard=a,this.initData=b,$("#overall-refresh-link").click(function(){integrumDashOverall.getOverallstate(!0)}),setInterval($.proxy(function(){const a=(new Date).getTime();this.finished&&a-this.lastexec>1e4&&(this.finished=!1,integrumDashOverall.getOverallstate(),this.lastexec=a)},this),2e3),$(".btn.btn-control-db").click(function(){integrumDashOverall.switchPropertiesObject($(this),!0)})},refresh:function(a,b){this.morrisAreaData={type:"line",data:{labels:[],datasets:[]},options:{responsive:!0,maintainAspectRatio:!1,title:{display:!1},tooltips:{mode:"index",intersect:!1,callbacks:{title:function(a,b){return b.labels[a[0].index].format("H:mm")}}},hover:{mode:"nearest",intersect:!0},legend:{display:!1},scales:{xAxes:[{type:"time",distribution:"series",ticks:{source:"labels"},time:{displayFormats:{minute:"H:mm",second:"H:mm:ss"}}}],yAxes:[{stacked:!0,ticks:{suggestedMin:0,suggestedMax:3,maxTicksLimit:5},scaleLabel:{display:!1}}]}}},this.ykeys=[];var c=new Date;c=new Date(c.getTime()-12e4);var d={period:c},e=[],f=[];for(var g in b)d[b[g].key.concat("Count")]=0,"period"!==b[g].key&&(this.ykeys.push(b[g].key.concat("Count")),e.push(b[g].label),f.push(b[g].color),this.morrisAreaData.data.datasets.push({dataitem:b[g].key.concat("Count"),borderColor:b[g].color,backgroundColor:b[g].color,label:b[g].label,data:[],type:"line",pointRadius:0,borderWidth:2}));this.addItem(d)},switchPropertiesObject:function(a,b){var c=a.data("original-title"),d=a.data("type"),e=a.data("system"),f=a.data("level");f=void 0===f?2e3:f,integrumDashOverall.objDashboard.trigger("idash-setControlList",[c,e,d,f,b])},prevdata:"",timestamp:Date.now(),getOverallstate:function(a){var b=new Date,c=this;$.ajaxQueue({dataType:"text",url:"/dashboard/overallstate/1/"+this.hierarchytree,xhrFields:{withCredentials:!0},success:function(d){c.finished=!0;try{var e=JSON.parse(d)}catch(f){console.log(f),$(location).attr("href","logout")}c.eventArchive!=parseInt(e.eventArchiveInProgress)&&(c.eventArchive=parseInt(e.eventArchiveInProgress),$(".panel-event").removeClass("ev-archive").addClass(c.eventArchive?"ev-archive":""),$(".panel-event .ev-spinner").removeClass("hidden").addClass(c.eventArchive?"":"hidden"));var g={period:b};if(c.prevdata!==d||Date.now()-c.timestamp>=1e3*c.CHART_INTERVAL||a){c.timestamp=Date.now(),c.prevdata=d;for(var h in e)$.inArray(h,c.ykeys)>-1&&(g[h]=e[h]);c.addItem(g),c.setIntegrumHuge(e)}c.setIntegrumAreaChart(),e=null},error:function(){$(location).attr("href","logout")}})},addItem:function(a){var b=this.morrisAreaData.data;b.labels.push(moment(a.period,"H:mm"));for(var c=0;c<b.datasets.length;c++){var d=b.datasets[c];d.data.push(a[d.dataitem]?parseInt(a[d.dataitem]):0)}if(b.labels.length>=this.HISTORY_LENGTH)for(b.labels.shift(),c=0;c<b.datasets.length;c++)d=b.datasets[c],d.data.shift();this.chart&&this.chart.update()},setIntegrumAreaChart:function(a){if(void 0===this.chart||a){var b=$("#integrum-area-chart");b.empty();var c=$("<canvas/>");c.appendTo(b);var d=c[0].getContext("2d");d.canvas.width=b.width(),d.canvas.height=b.height(),this.chart=new Chart(d,this.morrisAreaData)}},setIntegrumHuge:function(a){for(var b in a)if(b.indexOf("Count")>-1){var c=$("#huge-db-"+b.replace("Count",""));void 0!==c&&void 0!==c.parent()&&c.parent().length>0&&(integrumDashOverall.switchPropertiesObject(c.parent(),!1),c.text(a[b]))}}};jQuery(document).ready(function(a){a("#properties h3.panel-title span#name").click(function(){a(window).trigger("integrum-showHierarchy",this)}),a(".hideChart").click(function(b){for(var c=integrumDashOverall.morrisAreaData.data,d=a(b.currentTarget),e=d.find("i").hasClass("fa-eye-slash"),f=0;f<c.datasets.length;f++){var g=c.datasets[f];if(g.dataitem===d.data("datasetlabel").concat("Count")){g.hidden=!e,d.find("i").removeClass().addClass("fa fa-eye"+(e?"":"-slash")),integrumDashOverall.chart.update();break}}}),integrumDash.register(integrumDashOverall)}),function(a){var b={};b[a+"|loader"]=$("<div id='loader' class='loading'><i class='fa fa-cog fa-spin'></i></div>"),b[a+"|popup"]=$("<div id='popup' class='ol-popup'><a href='#' id='popup-closer' class='ol-popup-closer'></a><div id='popup-content' class='panel'></div></div>"),b[a+"|progress"]=$("<div id='progress'></div>"),b[a+"|panelWrapper"]=$("<div class='map-panel-wrapper' style='bottom: 0px;'><div class='panel-controller'><div class='tab-controller'><div id='map-title'></div><span class='closePanel' style='display: inline;'><i class='fa fa-arrow-down'></i></span><span class='showPanel' style='display: none;'><i class='fa  fa-arrow-up'></i></span></div></div><div class='panel-content'><div class='content clearfix'><div class='row'></div></div><!-- content --></div><!-- panel-content --></div>"),b[a+"|layerFeatureInfo"]=$("<div id='layerFeatureInfo'></div>"),b[a+"|timeInfo"]=$("<div id='timeInfo'></div>"),$.each(b,function(a,b){var c=/^([#a-z]*)\|/;if(c.test(a)){var d=c.exec(a);b.appendTo($(d[1]))}})}("#map"),window.app={};var app=window.app;jQuery.loadCSS=function(a){$('link[href="'+a+'"]').length||$("head").append('<link rel="stylesheet" type="text/css" href="'+a+'">')},app.TogglePanControl=function(a){var b=a||{},c=document.createElement("button");c.innerHTML='<i class="fa fa-mouse-pointer fa-stack-1x"></i>  <i class="fa fa-ban fa-stack-1x text-danger"></i>',c.title=WS.loaded.config.controls.panblock;var d=this,e=function(a){$(this).parents(".toggle-pan").hasClass("active")?($(this).parents(".toggle-pan").removeClass("active"),map.getInteractions().forEach(function(a){a instanceof ol.interaction.DragPan&&map.removeInteraction(a)}.bind(d))):($(this).parents(".toggle-pan").addClass("active"),map.addInteraction(new ol.interaction.DragPan))};c.addEventListener("click",e,!1),c.addEventListener("touchstart",e,!1);var f=document.createElement("div");f.className="toggle-pan ol-unselectable ol-control active",f.appendChild(c),ol.control.Control.call(this,{element:f,target:b.target})},app.RefreshControl=function(a){var b=a||{},c=document.createElement("button");c.innerHTML='<i class="fa fa-redo"></i>',c.title=WS.loaded.config.controls.reload;var d=function(a){WS.wsRequestState()};c.addEventListener("click",d,!1),c.addEventListener("touchstart",d,!1);var e=document.createElement("div");e.className="refresh ol-unselectable ol-control",e.appendChild(c),ol.control.Control.call(this,{element:e,target:b.target})},app.GoUpControl=function(a){var b=a||{},c=document.createElement("button"),d=WS.loaded.config;c.innerHTML='<i class="fa fa-level-up-alt"></i>',c.title=d.controls.parent;var e=function(a){0!==d.parentId&&WS.mapLink(d.parentId)};c.addEventListener("click",e,!1);var f=document.createElement("div");f.className="goup ol-unselectable ol-control",0!==d.parentId&&(f.className+=" active"),f.appendChild(c),ol.control.Control.call(this,{element:f,target:b.target})},app.EditModeControl=function(a){var b=a||{},c=document.createElement("button");c.innerHTML='<i class="fa fa-pencil"></i>';var d=document.createElement("div");d.className="editmode ol-unselectable ol-control";var e=function(a){app.editMode(),map.editMode?d.className+=" active":d.className=d.className.replace(" active","")};c.addEventListener("click",e,!1),d.appendChild(c),ol.control.Control.call(this,{element:d,target:b.target})},app.GetEditControl=function(a){var b=a||{},c=document.createElement("button");c.innerHTML='<i class="fa fa-download"></i>',c.title="MapEditor";var d=document.createElement("div");d.className=b.afterEdit?"mapeditor2 ol-unselectable ol-control active":"mapeditor ol-unselectable ol-control active";var e=function(a){var b=document.createElement("a");b.href="http://updates.satel.pl/mapeditor/v3.0/map_editor_setup.exe",b.target="_mapeditordownload",document.body.appendChild(b),b.click(),document.body.removeChild(b),delete b};c.addEventListener("click",e,!1),d.appendChild(c),ol.control.Control.call(this,{element:d,target:b.target})},app.findFeatureByReceivedData=function(a,b){var c=map.getLayerByLayerCode(a.layerCode);if(a.id){var d,e=Number(a.id);if(c){var f=c.getSource().getFeatures();f.forEach(function(a,b){var c=a.getProperties();return c.hasOwnProperty("id")&&Number(c.id)===e?(d=a,a):void 0})}else b.debugmode.states&&console.log("Layer not found:"+a.layerCode);return d}},app.zoomToFeature=function(a,b,c){var d=app.getFeature(a,b),e=d.getGeometry().getExtent();return d&&(bounce=ol.animation.bounce({resolution:map.getView().getResolution(),duration:1e3}),rotate=ol.animation.rotate({duration:1e3,rotation:0}),pan=ol.animation.pan({duration:1e3,source:map.getView().getCenter()}),zoom=ol.animation.zoom({duration:1e3,resolution:map.getView().getResolution()}),map.beforeRender(pan,zoom),c?map.getView().setCenter(ol.extent.getCenter(e)):map.getView().fit(e,map.getSize())),d},app.getFeature=function(a,b){var c,d=map.getLayerByLayerCode(b);return d.getSource().getFeatures().forEach(function(b){b.getId()===a&&(c=b)}),c},app.prepareLayer=function(a,b,c){var d=new ol.source.Vector({url:c.config.url.json+"/"+c.config.id+"/"+b.layerCode,format:new ol.format.GeoJSON({defaultDataProjection:defaultProjection})});d.vSourceId=a+1,deferredRequests[d.vSourceId]=$.Deferred();var e=(d.on("change",function(a){"ready"===this.getState()&&deferredRequests[this.vSourceId].resolve(this.vSourceId)}),new ol.layer.Vector({layerCode:b.layerCode,layerName:b.layerName,source:d,style:function f(a,b){var f=app.prepareStyle(a,b);return opt.debugmode.styles&&console.log(f),f}}));return e},app.modifyEnd=function(a){var b=a.features,c={};c.attributes=[],c.type="UpdateCoordinates",b.forEach(function(a){var b={};b.layer=a.get("layerCode"),b.id=a.getProperties().id(),b.coordinates=a.getGeometry().getCoordinates(),c.attributes.push(b)}),WS.wsSendMessage(JSON.stringify(c)),console.log(c)},app.editMode=function(){var a=map,b=this;if(a.editMode)a.getInteractions().forEach(function(b){(b instanceof ol.interaction.Modify||b instanceof ol.interaction.Select)&&a.removeInteraction(b)}),WS.wsRequestState(),a.editMode=!1;else{WS.defaultStyles();var c=new ol.interaction.Select({wrapX:!1}),d=new ol.interaction.Modify({features:c.getFeatures()});d.on("modifyend",b.modifyEnd),a.getInteractions().extend([c,d]),a.editMode=!0}},ol.inherits(app.TogglePanControl,ol.control.Control),ol.inherits(app.RefreshControl,ol.control.Control),ol.inherits(app.GoUpControl,ol.control.Control),ol.inherits(app.EditModeControl,ol.control.Control),ol.inherits(app.GetEditControl,ol.control.Control);var WS={options:{websocketUriBase:void 0,callback:void 0,mapLinkCallback:void 0,actionAttributeCallback:void 0,mapId:void 0,debugmode:void 0,urlPrefix:void 0,reuseConnection:!0,lang:navigator.language||navigator.userLanguage,respOkCode:"0"},refreshStateTimeOut:void 0,websocket:void 0,featureState:{},reconnectAttempts:1,manualDisconnect:!1,$content:void 0,$closer:void 0,actionEventsBinded:void 0,loaded:{},init:function(a){if($.extend(this.options,a),this.wsTimeout=setTimeout(this.wsTimeout,4e3),!this.options.mapId){var b=window.location.search,c=/\?(.*)$/.exec(b);c&&!/^r=/.test(c[1])&&(this.options.mapId=c[1]),this.options.mapId||(this.options.mapId="h1")}var d=document.createElement("a");if(d.href=this.options.websocketUriBase,"wss:"===d.protocol||"ws:"===d.protocol)this.websocketUri=this.options.websocketUriBase+this.options.mapId;else{var e,f=window.location;e="https:"===f.protocol?"wss:":"ws:",e+="//"+f.host,this.websocketUri=e+this.options.websocketUriBase+this.options.mapId}this.$content=$("#popup-content"),this.$closer=$("#popup-closer"),this.overlay=new ol.Overlay({element:$("#popup")[0]});try{try{this.websocket&&1===this.websocket.readyState&&!this.options.reuseConnection&&(this.wsSendCloseMessage(),this.websocket=void 0)}catch(g){console.log(g)}this.websocket&&this.options.reuseConnection?this.options.reuseConnection&&this.wsMapRequest(this.options.mapId):(this.websocket=new WebSocket(this.websocketUri),this.websocket.onopen=this.wsOnOpen.bind(this),this.websocket.onclose=this.wsOnClose.bind(this),this.websocket.onmessage=this.wsOnMessage.bind(this),this.websocket.onerror=this.wsOnError.bind(this))}catch(g){console.log(g)}},overlay:void 0,wsOnOpen:function(a){this.reconnectAttempts=1,this.manualDisconnect=!1,this.writeToReceivedBox("CONNECTED"),$(document).trigger("ws-open",a),setTimeout(function(){$(document).trigger("ws-alert-close")},1e3)},wsAddPopupEvents:function(){this.actionEventsBinded||(this.$content.on("click",".feature-title",function(a){$(document).trigger("feature-title-click",$(a.target).data())}),this.$content.on("click","a",this.doAction.bind(this)),this.$closer.on("click",function(){return WS.popupSetPosition(void 0),this.blur(),!1}),this.actionEventsBinded=!0)},popupSetPosition:function(a){WS.overlay.setPosition(a)},wsOnError:function(a){$(document).trigger("ws-error",a),this.writeToReceivedBox('<span style="color: red;">ERROR:</span> '+a.data)},wsOnMessage:function(a){var b=this;$(document).trigger("ws-pre-message",a),this.writeToReceivedBox(a.data);var c=JSON.parse(a.data);$.isArray(c)?$.each(c,function(a,c){b.onMessage(c)}):this.onMessage(c),$(document).trigger("ws-post-message",a)},onMessage:function(a){if(a.type)switch(a.type){case"Connected":this.wsMapRequest(this.options.mapId),clearTimeout(this.wsTimeout),$(document).trigger("ws-connected",a);break;case"State":this.wsReceivedState(a),$(document).trigger("ws-state",a);break;case"Notification":$(document).trigger("ws-notification",a);break;case"MapConfig":$("#mapnotfound").hide(),this.wsRreceivedConfig(a),$(document).trigger("ws-config",a);break;case"ActionResponse":switch($("#progress [data-cmd-id="+a["cmd-id"]+"]").remove(),$("#mapnotfound").hide(),a.respCode){case this.options.respOkCode:break;case"NOMAP":case"MAPNOTFOUND":$("#mapnotfound").show(),$("#loader").hide();break;default:a.respMessage?$(document).trigger("ws-alert",a.respMessage):$(document).trigger("ws-alert",a.respCode)}$(document).trigger("ws-action-response",a)}},wsOnClose:function(a){if(/^Apple/.test(navigator.vendor)&&1006===a.code)clearTimeout(this.wsTimeout),this.disposeLoader(),$(document).trigger("ws-alert",["Error","fatal error"]);else if($(document).trigger("ws-close",a),this.writeToReceivedBox("DISCONNECTED"),this.refreshStateTimeOut&&(clearTimeout(this.refreshStateTimeOut),this.refreshStateTimeOut=void 0),!this.manualDisconnect){var b=this.generateInterval(this.reconnectAttempts);setTimeout(function(){this.reconnectAttempts++,this.wsReconnect(),this.options.debugmode.websocket?console.log("Reconnecting attempt:"+this.reconnectAttempts+" in "+parseInt(b)+"ms"):null}.bind(this),b)}},wsMapRequest:function(a){this.options.mapId=a;var b={type:"ConfigRequest",token:this.options.token,id:a,action:this.options.lang};this.wsSendMessage(JSON.stringify(b))},wsSendMessage:function(a){if(1!==this.websocket.readyState)return this.options.debugmode.websocket?console.log(a):null,!1;var b;try{var c=JSON.parse(a),d=$.grep(this.loaded.config.layers,function(a){return a.layerCode===c.layer})[0],e=$.grep(d.actions,function(a){return a.actionCode===c.action})[0];b=new Date(parseInt(c["cmd-id"])).toLocaleTimeString()+" "+d.layerName+" -> "+e.descr}catch(f){}if(c.type&&"Action"===c.type){if(c.confirm&&!confirm(this.loaded.config.controls.confirm))return!1;var g=$("<i/>",{"class":"fa fa-cog fa-spin","data-cmd-id":c["cmd-id"]});$("#progress").append(g)}this.writeToSentBox(a),this.websocket.send(a)},wsReconnect:function(){$("#progress").empty();var a,b;this.loaded.config?(a=this.loaded.config.controls.disconnected,b=this.loaded.config.controls["disconnected-msg"]):(a="Rozłączono",b="Próbuję ponownie połączyć"),$(document).trigger("ws-alert",[a,b]),this.init(this.options)},wsTimeout:function(a){$(document).trigger("ws-timeout",a);var b,c;this.loaded&&this.loaded.config?(b=this.loaded.config.controls.contimeout,c=this.loaded.config.controls["contimeout-msg"]):(b="Timeout",c="Przekroczony czas połączenia."),$(document).trigger("ws-alert",[b,c])},wsRreceivedConfig:function(a){$(document).trigger("ws-received-config",a),this.loaded.config=a,this.loaded.config.url={},this.loaded.config.url.json=this.options.urlPrefix+"/maps-web-service/webgetlayer",this.loaded.config.url.rsc=this.options.urlPrefix+"/maps-web-service/webgetrsc",this.loaded.styles=a.styles,this.options.callback(this.loaded,!0),this.refreshStateTimeOut=setTimeout(this.wsRequestState.bind(null,this),12e5)},wsRequestState:function(a){var b={type:"StateRequest"};void 0===a?this.wsSendMessage(JSON.stringify(b)):(a.wsSendMessage(JSON.stringify(b)),a.refreshStateTimeOut=setTimeout(a.wsRequestState.bind(null,a),12e5))},wsReceivedState:function(a){if("UNI-TXT"!==a.layerCode){$(document).trigger("ws-received-state",a);var b=app.findFeatureByReceivedData(a,this.options);if(b){$(document).trigger("map-received-state",[b,a]);var c=[],d=[];$(".tooltip").remove();var e=$("."+a.layerCode).find(".panel-state-"+a.layerCode+"-"+b.getProperties().id);e&&e.empty(),a.attributes&&$.each(a.attributes,function(a,b,d){$.isArray(d)&&c.push(b+" "+d.join(" "))}.bind(this,a)),this.parseCSSClassAndGetOlStyle(c,a,"INT-INT"==a.layerCode,$.proxy(function(d){var e=this.fixRotationAndScale(b,d);b.setStyle(e),b.mappingStyle=c,b.currentState=a.attributes,b.changed()},this)),this.featureState[a.layerCode]||(this.featureState[a.layerCode]={});var f=$.grep(this.loaded.config.layers,function(b){return b.layerCode===a.layerCode})[0];d=c.map(function(a){return f.stateLabels[a]});var g=$.grep(this.loaded.config.layers,function(b){return a.layerCode===b.layerCode?b:void 0})[0];this.applyStateToDOM(c,$(".panel ."+a.layerCode+a.id+" .state-wrapper"),g.stateLabels),this.featureState[a.layerCode][a.id]=a.attributes}}},wsSendCloseMessage:function(){var a={type:"Close","cmd-id":Date.now().toString()};this.manualDisconnect=!0,this.wsSendMessage(JSON.stringify(a))},parseCSSClassAndGetOlStyle:function(a,b,c,d){var e=!1,f=$("#id"+b.id+".ol-viewport."+b.layerCode);0==f.length&&(f=$("<div/>",{id:"id"+b.id,"class":"ol-viewport "+b.layerCode}).appendTo("#ol-css-viewport"));var g;g=a.length>0?f.find("div."+a.join(".").replace(" ",".")).filter(function(){return this.className.length==a.join(" ").length}):f.find("div"),0==g.length&&(g=$("<div/>").appendTo(f),g.addClass(a.join(" ")));var h,i=window.getComputedStyle(g[0]),j={};if(b.attributes.color)h=b.attributes.color,j.fill=new ol.style.Fill({color:"rgba("+h.r+","+h.g+","+h.b+","+h.a+")"});else if("none"!=i.backgroundImage)if(c){var k,l=$("#ol-css-viewport").find("canvas");0==l.length&&(l=$("<canvas>").appendTo("#ol-css-viewport"));var m=l[0].getContext("2d"),n=new Image;n.onload=function(){var a=m.createPattern(n,"repeat");j.fill=new ol.style.Fill({color:a}),d(new ol.style.Style(j))};var o;i.backgroundImage.startsWith("url")?(o=i.backgroundImage.replace('url("',"").replace("url('",""),o=o.substring(0,o.length-2)):o=i.backgroundImage,e=!0,n.src=o}else/^url/.test(i.backgroundImage)&&(k=i.backgroundImage.replace(/^url\("/,"").replace(/"\)$/,""),j.image=new ol.style.Icon({src:k,opacity:i.opacity,rotateWithView:!0}));else if(i.backgroundColor){var p;p=/^rgba/.test(i.backgroundColor)?i.backgroundColor:i.backgroundColor.replace(/^rgb/,"rgba").replace(/\)$/,"")+", "+i.opacity+")",j.fill=new ol.style.Fill({color:p})}var q=parseFloat(i.borderWidth);if(q){var r=0;switch(i.borderStyle){case"dashed":r=[5*q,5*q];break;case"dotted":r=[q,q];break;default:r=[0]}j.stroke=new ol.style.Stroke({color:i.borderColor,width:parseInt(i.borderWidth),lineDash:r,lineCap:"butt"})}map.getLayerByLayerCode(b.layerCode).get("showLabel")&&(j.text=new ol.style.Text({font:"12px sans-serif",fill:new ol.style.Fill({color:"black"}),stroke:new ol.style.Stroke({color:"white",width:2})})),this.options.debugmode.styles&&console.log(a,j),e||d(new ol.style.Style(j))},fixRotationAndScale:function(a,b){var c=1.03,d=3;return function(a){return b.getText()&&(this.get("name")&&d>a?d>2*a?b.getText().setText(this.get("name")):b.getText().setText(this.get("name").replace(/ /g,"\n")):b.getText().setText()),b.getImage()&&(this.get("rot")&&b.getImage().setRotation(this.get("rot")),this.get("scale")&&b.getImage().setScale(this.get("scale")/a*c)),[b]}.bind(a)},findByDataAction:function(a){var b,c=app.getLayerById(a.layerCode),d=Number(a.attributes.integraId);if(c){var e=c.getSource().getFeatures();e.forEach(function(a){var c=a.getProperties();return c.hasOwnProperty("id")&&Number(c.id)===d?(b=a,a):void 0})}else console.log("Layer not found");return b},defaultStyles:function(){map.getLayers().forEach(function(a){a instanceof ol.layer.Vector&&a.getSource().getFeatures().forEach(function(a){a.setStyle(null)})})},disposeLoader:function(){$("#loader").remove()},doAction:function(a){if("url"!==$(a.target).data("actiontype")&&"mapUrl"!==$(a.target).data("actiontype")){var b={cancel:!1};$(this).trigger("map-pre-action",b),$.when(b.cancel).then($.proxy(function(b){if(!b){var c={type:"Action","cmd-id":Date.now().toString()};c.id=$(a.target).closest("ul").data("id"),c.action=$(a.target).data("action"),c.layer=$(a.target).data("layer"),c.confirm=$(a.target).data("confirm"),void 0!==this.options.actionAttributeCallback&&(c.attributes=this.options.actionAttributeCallback(c.layer,c.action,c.id)),this.wsSendMessage(JSON.stringify(c))}this.$closer.trigger("click")},this)).fail($.proxy(function(){this.$closer.trigger("click")},this))}},generateInterval:function(a){var b=1e3*(Math.pow(2,a)-1);return b>3e4&&(b=3e4),Math.random()*b},writeToReceivedBox:function(a){this.options.debugmode.websocket&&console.log("RCV:"+a)},writeToSentBox:function(a){this.options.debugmode.websocket&&console.log("SNT:"+a)},mapLink:function(a){this.popupSetPosition(void 0),$(document).trigger("ws-alert-close"),void 0===this.options.mapLinkCallback?this.mapLinkInternal(a):this.options.mapLinkCallback(a)},mapLinkInternal:function(a){this.wsMapRequest(a)},buildActionsPopup:function(a){if(!map.editMode){if($(document).trigger("ws-popup",a),a.layerConfig.hasOwnProperty("actions")){var b=$("<div>",{"class":"panel "+a.layer.get("layerCode")});a.feature.get("name")&&b.append("<div class='feature-title pull-left "+a.layer.get("layerCode")+"' data-layer_code='"+a.feature.get("layerCode")+"' data-feature_id='"+a.feature.get("id")+"'> "+a.feature.get("name")+"</div>");var c=["default","type9"],d=$(a.feature.mappingStyle).not(c).get();if(d.length){var e=$("<div/>",{"class":"state-wrapper panel-state-"+a.layer.get("layerCode")+"-"+a.feature.get("id")}).appendTo(b);this.applyStateToDOM(a.feature.mappingStyle,e,a.layerConfig.stateLabels)}var f=$("<ul/>",{"data-id":a.feature.get("id")}).appendTo(b);return WS.$content.append(b),a.layerConfig.autoOpenAction===!0&&a.featuresCount&&1===a.featuresCount?WS.actionAutoOpen(a):($.each(a.layerConfig.actions,this.buildActionsList.bind(null,f,a)),!0)}return!1}},applyStateToDOM:function(a,b,c){b.empty();var d=[];$.each(a,function(a,c,e){var f=e.split(" ")[0],g=e.split(" ");switch(f){case"users":d.push($("<div/>",{"class":f,html:'<i class="fa fa-users"></i> <span class="badge">'+g[1]+"</span>"}));break;default:var h=g.map(function(a,b,c){return c>0&&void 0!==a[f]?a[f][b]:void 0}.bind(null,a));b.append($("<div/>",{"class":e,title:h.filter(Boolean).join(", ")}))}}.bind(null,c)),d.length&&$.each(d,function(a,c){b.append(c)})},buildActionsList:function($actionList,options,i,action){var isVisible,_fcs=options.feature.currentState,_fprop=options.feature.getProperties(),visibleExpr=action.actionActiveExp.replace(/=state/g,"_fcs");visibleExpr=visibleExpr.replace(/=properties/g,"_fprop"),visibleExpr=visibleExpr.replace(/isOn\(/g,"-1<$.inArray(");try{isVisible=parseBool(eval(visibleExpr))}catch(e){isVisible=!1}if(isVisible){var link={};link.url="#","url"===action.actionType&&(""!==_fprop[action.actionCode]?link.url=_fprop[action.actionCode]:link["class"]="disabled",link.target="_blank"),"mapUrl"===action.actionType?link.url="javascript: WS.mapLink("+_fprop.id+");":null;var $actionLink=$("<a/>",{href:link.url,target:link.target,"class":link["class"],html:action.descr});$actionLink.data({actiontype:action.actionType,action:action.actionCode,layer:options.layer.get("layerCode"),confirm:action.confirm}),$actionList.append($("<li/>").append($actionLink))}},actionAutoOpen:function(a){var b=a.feature.getProperties(),c=a.layerConfig.actions[0];switch(c.actionType){case"url":window.open(b[c.actionCode],"_blank");break;case"mapUrl":WS.mapLink(b.id)}return!1}},map={},styles={},console=window.console||{},backgroupRefresh,refreshTimerFunc=function(){$.get("/ver/1",function(){backgroupRefresh=setTimeout(refreshTimerFunc,6e4)}).fail(function(){window.location.href="/logout"})},satelol3=function(){var a,b,c=([new ol.style.Style({stroke:new ol.style.Stroke({color:"#f00",width:1})})],function(a){backgroupRefresh&&clearTimeout(backgroupRefresh),backgroupRefresh=setTimeout(refreshTimerFunc,6e4);var b={uri:"ws://192.168.1.11:8080/maps-web-service/webregisterstatelistener/1/",mapLinkCallback:void 0,actionAttributeCallback:void 0,mapId:void 0,urlPrefix:"/maps",assetsPath:"assets/",showEditButton:!0,showDownloadButton:!1,debugmode:{websocket:!1,styles:!1,states:!1}};$.extend(b,a),$.loadCSS(b.urlPrefix+"/maps-web-service/webgetrsc/css/0"),WS.init({manager:this,websocketUriBase:b.uri,callback:this.mapsInit,mapLinkCallback:b.mapLinkCallback,actionAttributeCallback:b.actionAttributeCallback,mapId:b.mapId,lang:b.lang,urlPrefix:b.urlPrefix,assetsPath:b.assetsPath,debugmode:b.debugmode,token:b.token,respOkCode:b.respOkCode}),$(WS).on("map-pre-action",$.proxy(function(a,b){$(this).trigger("map-pre-action",b)},this)),this.options=b}),d=function(){var a=map.getView(),b=this.mapextent?this.mapextent:a.getProjection().getExtent(),c=map.getSize();a.fit(b,c)},e=function(a,b){var c=[],d=[],e=new ol.proj.Projection(a.config.projection);satelol3.backextent=[a.config.background.x,a.config.background.y,a.config.background.width+a.config.background.x,a.config.background.height+a.config.background.y];var f=new ol.source.ImageStatic({imageExtent:satelol3.backextent,imageSize:[a.config.background.width,a.config.background.height],url:a.config.url.json+"/"+a.config.id+"/background"});satelol3.mapextent=void 0,satelol3.layerdone=0,d.push(new ol.layer.Image({layerCode:"background",source:f,opacity:1})),$("#map-title").html(a.config.name),satelol3.layercount=a.config.layers.length,satelol3.layerdone=0,$.each(a.config.layers,function(b,f){$.loadCSS(WS.options.assetsPath+f.layerCode+"/layer.css"),f.cssUrl&&$.loadCSS(WS.options.urlPrefix+"/"+f.cssUrl);var g=new ol.source.Vector({url:a.config.url.json+"/"+a.config.id+"/"+f.layerCode,format:new ol.format.GeoJSON({defaultDataProjection:e})});g.on("change",function(){satelol3.layerdone++,satelol3.mapextent?ol.extent.extend(satelol3.mapextent,this.getExtent()):satelol3.mapextent=this.getExtent(),satelol3.layerdone===satelol3.layercount&&(ol.extent.extend(satelol3.mapextent,satelol3.backextent),satelol3.fitMap())}),g.vSourceId=b+1,c[g.vSourceId]=$.Deferred(),g.on("change",function(){"ready"===this.getState()&&c[this.vSourceId].resolve(this.vSourceId)});var h={layerCode:f.layerCode,layerName:f.layerName,showLabel:f.showLabel,source:g};"UNI-TXT"===f.layerCode&&(h.style=function(a,b){var c=a.getProperties(),d=1.03;return[new ol.style.Style({text:new ol.style.Text({font:(c.italic?"italic ":"")+(c.bold?"bold ":"")+(c.size?c.size:"10")/b*d+"px "+c.family,placement:"line",rotateWithView:!0,rotation:c.rot,fill:new ol.style.Fill({color:c.color?"rgba("+c.color.r+","+c.color.g+","+c.color.b+","+c.color.a+")":"black"}),stroke:new ol.style.Stroke({color:"white",width:2}),text:c.text})})]});var i=new ol.layer.Vector(h);d.push(i)});var g={units:"m",target:"map",controls:new ol.Collection([new ol.control.FullScreen({tipLabel:a.config.controls.fullscreen,label:$('<i class="fa fa-expand"></i>')}),new ol.control.Zoom({zoomInTipLabel:a.config.controls.zoomin,zoomOutTipLabel:a.config.controls.zoomout}),new ol.control.ZoomToExtent({tipLabel:a.config.controls.fit,label:$('<i class="fa fa-arrows-alt"></i>')}),new app.TogglePanControl,new app.RefreshControl,new app.GoUpControl]),layers:d,overlays:[WS.overlay],view:new ol.View({center:a.config.view.center,projection:e,zoom:0,maxZoom:5})};this.manager.options.showEditButton&&g.controls.push(new app.EditModeControl),this.manager.options.showDownloadButton&&g.controls.push(new app.GetEditControl({afterEdit:this.manager.options.showEditButton||!1})),b?(void 0!==$("#map .ol-viewport")&&$("#map .ol-viewport").remove(),map=new ol.Map(g),WS.wsAddPopupEvents()):map=map||new ol.Map(g),map.editMode=!1,b=!1,satelol3.fitMap();var h=function(a){var b=$("#layerFeatureInfo");b.html("<ul></ul>"),map.forEachFeatureAtPixel(a,function(a,c){a&&"UNI-TXT"!==c.get("layerCode")&&b.find("ul").append($("<li/>",{"class":c.get("layerCode"),text:a.get("name")}))})};map.forEachLayerRecursive=function(a,b){a.getLayers().forEach(function(a,c,d){b(a,c,d),a.getLayers&&ol.control.LayerSwitcher.forEachRecursive(a,b)})},map.getLayerByLayerCode=function(a){var b;return map.forEachLayerRecursive(this,function(c){return c.get("layerCode")===a?(b=c,c):void 0}),b},map.on("pointermove",function(a){if(!a.dragging){var b=map.getEventPixel(a.originalEvent);h(b)}}),map.on("click",function(b){var c=!1,d=0;WS.$content.html(""),map.forEachFeatureAtPixel(b.pixel,function(a,b){var c=b.get("layerCode");void 0!==c&&"UNI-TXT"!==c&&a&&b&&d++}),map.forEachFeatureAtPixel(b.pixel,function(b,e){if(b&&e){var f=b.get("id"),g=e.get("layerCode");if(void 0===g||"UNI-TXT"===g)return;if(WS.$content.data("id",f),1!==WS.websocket.readyState)WS.$content.html("Brak połączenia.");else{var h=$.grep(a.config.layers,function(a){return a.layerCode===g});h[0]&&(c=WS.buildActionsPopup({feature:b,layerConfig:h[0],layer:e,featuresCount:d}))}}}),c?WS.popupSetPosition(b.coordinate):WS.popupSetPosition(void 0)}),$.when.apply(this,c).done(function(){map.cachedStyles={},$("#map").css("background-color",a.config.background.color),WS.disposeLoader(),Panel.init(WS,map),WS.wsRequestState()})};return{init:c,mapsInit:e,options:a,fitMap:d,mapextent:b,backextent:void 0,layercount:void 0,layerdone:0}}();$(document).ready(function(){document.showTime?window.setInterval(function(){var a=new Date,b=("00"+a.getHours()).slice(-2)+":"+("00"+a.getMinutes()).slice(-2)+":"+("00"+a.getSeconds()).slice(-2);$("#timeInfo").html(b)},1e3):($("#timeInfo").hide(),$("#layerFeatureInfo").css("bottom","0")),$(document).on("click",".tab-controller",function(){Panel.togglePanel()}),$(document).on("click",".zoomTo",function(){var a=$(this).data("featureid"),b=$(this).data("layercode");app.zoomToFeature(a,b,!1)}),$(document).on("click",".panelPopup",function(){WS.$content.html("");var a,b=$(this).data("featureid"),c=$(this).data("layercode"),d=app.getFeature(b,c),e=map.getLayerByLayerCode(c),f=d.getGeometry();a=f instanceof ol.geom.Polygon?f.getInteriorPoint().getFirstCoordinate():f.getFirstCoordinate(),WS.buildActionsPopup({feature:d,layerConfig:$.grep(WS.loaded.config.layers,function(a){return a.layerCode===c})[0],
layer:e}),app.zoomToFeature(b,c,!0),WS.popupSetPosition(a)})});var Panel={isVisible:!0,showMessage:null,hideMessage:null,animationDuration:500,animationEasing:"easeInOutCubic",init:function(a,b){$(".panel-content .content").find(".row").empty(),b.getLayers().forEach(function(a){var b=a.get("layerName"),c=a.get("layerCode");if("background"!==c){var d=$('<div class="col-md-4 col-xl-3 pl-0"><div class="panel panel-primary '+c+'">\n<div class="panel-heading"><input placeholder="'+b+'" type="search" class="form-control panel-title layerFilter" >\n<span class="layerIcon form-control-feedback" aria-hidden="true"></span>\n<input type="checkbox" class="pull-right layerToggle" data-code="'+c+'" checked="checked" /> \n</div><div class="panel-body"><div class="map-panel-body-wrapper"></div></div></div></div>');$(".panel-content .row").append(d);var e=a.getSource().getFeatures();$.each(e,function(b,c,e){var f=a.get("layerCode"),g=e.getId(),h=$("<li class='"+f+e.getProperties().id+"'></li>").append($("<div class='panelPopupDiv'/>").append($("<a/>",{href:"#","class":"panelPopup",id:"panel-"+g,"data-attrid":e.getProperties().id,"data-featureid":g,"data-layercode":f,html:e.get("name"),title:e.get("name")}))).append($("<a/>",{href:"#","class":"zoomTo","data-attrid":e.getProperties().id,"data-featureid":g,"data-layercode":f,html:'<i class="fa fa-search"></i>'})).append($("<div/>",{"class":"state-wrapper","data-featureid":g}));d.find(".map-panel-body-wrapper").append(h)}.bind(null,this.styles[c]))}}),$(".layerFilter").addClear({symbolClass:"fa fa-times",wrapperClass:"mb-0",top:"11px",right:"16px",onClear:function(a){this.layerFilter(void 0,a)}.bind(this)}),$(".map-panel-wrapper").tooltip({selector:'[data-toggle="tooltip"]',container:"#map"}),$("body").on("keyup",".layerFilter",this.layerFilter),$("body").on("change",".layerToggle",this.layerToggle),this.hidePanel()},hidePanel:function(){$(".map-panel-wrapper").animate({bottom:-Panel.getAnimationOffset()},Panel.animationDuration,Panel.animationEasing,function(){Panel.isVisible=!1,Panel.updateTabMessage()})},showPanel:function(){$(".map-panel-wrapper").animate({bottom:0},Panel.animationDuration,Panel.animationEasing,function(){Panel.isVisible=!0,Panel.updateTabMessage()})},togglePanel:function(){(Panel.isVisible?Panel.hidePanel:Panel.showPanel)()},updateTabMessage:function(){this.isVisible?($(".tab-controller .closePanel").css("display","inline-block"),$(".tab-controller .showPanel").hide()):($(".tab-controller .closePanel").hide(),$(".tab-controller .showPanel").css("display","inline-block"))},getAnimationOffset:function(){return $(".panel-content").height()},layerToggle:function(){var a=$(this).prop("checked"),b=map.getLayerByLayerCode($(this).data("code"));b.setVisible(a)},layerFilter:function(a,b){var c=b?b:$(this),d=new RegExp(c.val(),"i");$.each(c.closest(".panel").find("li"),function(a,b){d.test($(b).text())?$(b).removeClass("hidden"):$(b).addClass("hidden")})}};