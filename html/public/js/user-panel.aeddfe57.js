function IntegraUserRights(a){this.trans={slctNoPartition:$("#trans-slct-no-partition").val(),slctPartitionLabel:$("#translate-select-partition-label").val(),slctAddNewComboDescr:$("#translate-selectAddNew").val(),userType:$("#translate-user-type").val(),rightsListTitle:$("#translate-user-rights").val()},this.userTypes=JSON.parse($("#user-types").val()),this.userAccess=JSON.parse($("#user-access").val()),this.objnames={objectId:"#objectId",objectIdPanel:"#objectIdPanel",partitionList:"#partitionList",partitionListLabel:"#partitionListLabel",partitionListLabelOutside:"#partitionListLabelOutside",profileList:"#input-profileList",profileListValue:"#profile-id",userCntSection:"#userCntSection",userSchemaSection:"#userSchemaSection",userCnt:"#userCnt",userSchema:"#userSchema",userSchemaCnt:"#userSchemaCnt",userType:"#userType",profileInfo:"#profileInfo",profileRights:"#profileRights",profileRightsEditable:"#profileRightsEditable",profileRightsDetails:"#profileRightsDetails",profileRightsDetailsHas:"#profileRightsDetailsHas",profileRightsDetailsDont:"#profileRightsDetailsDont",profileDropDown:"#profileDropDown",profileDropDownMenu:"#profileDropDownMenu",accessList:"#accessList"},this.$parent=a,this.selectedId=null,this.defPermissionuserpanels=$.Deferred(),this.permissionuserpanels=void 0,this.integra_id=void 0,this.integraUser_id=void 0,this.partition_id=void 0,this.user_id=void 0,this.token=void 0,this.$parent.on("click","#accessList input.regular-checkbox",$.proxy(function(){this.activateSave()},this)),this.$parent.on("change",this.objnames.profileList,$.proxy(function(a){this.setSelectedProfile($(a.currentTarget).val())},this)),this.$parent.find("#check-all").click($.proxy(function(){$("#accessList input[type=checkbox]").prop("checked",!0),this.activateSave()},this)),this.$parent.find("#check-none").click($.proxy(function(){$("#accessList input[type=checkbox]").prop("checked",!1),this.activateSave()},this)),this.$parent.find("#check-invert").click($.proxy(function(){var a=$("#accessList input[type=checkbox]:checked"),b=$("#accessList input[type=checkbox]:not(:checked)");a.prop("checked",!1),b.prop("checked",!0),this.activateSave()},this)),this.$parent.find(this.objnames.profileList).data("open",!1),this.$parent.on("click",this.objnames.profileList,$.proxy(function(){0==this.$parent.find(this.objnames.profileList).data("open")?(this.$parent.find(this.objnames.profileList).data("open",!0),$(document).mouseup($.proxy(function(){return $.get("/admin/profilelist",$.proxy(function(a){var b=this.getSelectedProfile();this.$parent.find(this.objnames.profileList).empty(),$.each(a,$.proxy(function(a,b){this.$parent.find(this.objnames.profileList).append($("<option>",{value:b.id,text:b.name,"data-utype":b.t}))},this)),this.$parent.find(this.objnames.profileDropdown).dropdown(),this.setSelectedProfile(b)},this)),$(document).unbind("mouseup"),setTimeout($.proxy(function(){this.$parent.find(this.objnames.profileList).data("open",!1)},this),1),!1},this))):$(this.objnames.profileList).data("open",!1)},this)),this.$parent.on("click",this.objnames.profileDropDown,$.proxy(function(){this.$parent.find(this.objnames.profileDropDown).prop("disabled",!0),$.ajax({url:"/admin/profilelist",async:!1,success:$.proxy(function(a){var b=this.$parent.find(this.objnames.profileDropDown).val();this.$parent.find(this.objnames.profileDropDownMenu).empty(),$.each(a,$.proxy(function(a,b){this.$parent.find(this.objnames.profileDropDownMenu).append($('<li data-value="'+b.id+'" data-utype="'+b.t+'"><a href="#">'+b.name+"</a></li>"))},this)),this.setSelectedProfile(b),this.$parent.find(this.objnames.profileDropdownMenu).dropdown("toggle"),this.$parent.find(this.objnames.profileDropDown).prop("disabled",!1)},this)})},this)),this.$parent.on("click",this.objnames.profileDropDownMenu+" li a",$.proxy(function(a){var b=$(a.currentTarget.parentNode).data("value");this.$parent.find(this.objnames.profileDropDown).val(b);var c=$(a.currentTarget.parentNode).data("utype");$("#userType").val(c),this.activateSchemaAndCount(c),this.loadProfileData(b),this.activateSave()},this)),this.$parent.on("change",this.objnames.objectId,$.proxy(function(a){this.$parent.find(this.objnames.partitionList+" input[type=checkbox]").prop("checked",!1),this.partition_id=a.target.value,this.permissionUserGet()},this)),this.$parent.on("change",this.objnames.profileList,$.proxy(function(a){var b=$(a.target.options[a.target.selectedIndex]).data("utype");$("#userType").val(b),this.activateSchemaAndCount(b),this.activateSave()},this)),this.$parent.on("focusout keyup input",this.objnames.userCnt+","+this.objnames.userSchema+","+this.objnames.userSchemaCnt,$.proxy(function(){this.activateSave()},this)),this.$parent.on("change",".regular-checkbox",$.proxy(function(){this.setSelectedProfile(0)},this)),this.$parent.on("change",this.objnames.profileList,$.proxy(function(a){this.clearUserTypeAndAccessList(),"0"===a.target.value?this.permissionUserGet():this.loadProfileData(a.target.value),this.activateSave()},this)),this.$parent.on("change",this.objnames.userType,$.proxy(function(a){this.activateSchemaAndCount(a.target.value),this.activateSave()},this)),this.$parent.on("click",this.objnames.profileInfo,$.proxy(function(){this.$parent.find(this.objnames.profileRights).toggle(),this.$parent.find(this.objnames.profileRightsEditable).toggle()},this))}IntegraUserRights.prototype.getSelectedProfile=function(){return this.$parent.find(this.objnames.profileListValue).val()},IntegraUserRights.prototype.setSelectedProfile=function(a){a>=0&&this.$parent.find(this.objnames.profileList).val(a),this.$parent.find(this.objnames.profileListValue).val(a)},IntegraUserRights.prototype.isInt=function(a){return""===a||null===a||void 0===a?!1:a%1===0},IntegraUserRights.prototype.prepareIntegra=function(a,b,c,d,e){return this.setUserTypeAndAccessList(null,void 0),this.integra_id=a,this.integraUser_id=c,this.user_id=d,this.token=e,this.activateSave(),this.trigger("edit-user-prepare-integra"),this.integra_id&&this.isInt(this.integra_id)?("none"==this.$parent.css("display")&&this.$parent.show(),this.setObject(this.integra_id,b)):(this.$parent.hide(),this.clearObject(),this.$parent.find(this.objnames.objectId).prop("disabled",!0)),this},IntegraUserRights.prototype.clearObject=function(){this.$parent.find(this.objnames.objectId).empty(),this.$parent.find(this.objnames.partitionList).empty(),this.$parent.find(this.objnames.userCntSection).hide(),this.$parent.find(this.objnames.userSchemaSection).hide(),this.$parent.find(this.objnames.partitionListLabel).html(this.trans.slctNoPartition)},IntegraUserRights.prototype.loadProfileData=function(a){$.get({url:"/admin/profile/"+a,dataType:"json",integraUserRights:this,success:function(a){var b=this.integraUserRights;b.$parent.find(b.objnames.accessList+" input[type=checkbox]").prop("checked",!1),b.setUserTypeAndAccessList(a.usertypeid,a.list)}})},IntegraUserRights.prototype.setObject=function(a,b){$.get({integraUserRights:this,dataType:"json",url:"/control/"+a+"/jstructure/1",success:function(a){var c=this.integraUserRights;c.trigger("edit-user-structureloaded",a);var d=c.$parent;c.integraObjects=a,c.clearObject(),c.$parent.find(c.objnames.objectId).prop("disabled",!1);for(var e=0;e<a.length;e++){var f=a[e];d.find(c.objnames.objectId).append('<option value="'+f.id+'">'+f.text+" </option>")}d.find(c.objnames.objectId+" option[value="+b+"]").length>0?(d.find(c.objnames.objectId).val(b),d.find(c.objnames.objectId).trigger("change"),2===a.length?d.find(c.objnames.objectIdPanel).hide():d.find(c.objnames.objectIdPanel).show(),d.find(c.objnames.partitionList).focus()):2===a.length?(d.find(c.objnames.objectId).val(a[1].id),d.find(c.objnames.objectId).trigger("change"),d.find(c.objnames.objectIdPanel).hide(),d.find(c.objnames.partitionList).focus()):(d.find(c.objnames.objectId).removeAttr("disabled"),d.find(c.objnames.objectIdPanel).show(),d.find(c.objnames.objectId).focus())}})},IntegraUserRights.prototype.clearPanels=function(){this.clearObject()},IntegraUserRights.prototype.partitionList=function(a){this.$parent.find(this.objnames.partitionList).empty();for(var b=0,c=0;c<this.integraObjects.length;c++){var d=this.integraObjects[c];if(d.id==this.partition_id){this.$parent.find(this.objnames.partitionListLabel).html(this.$parent.find(this.objnames.partitionListLabelOutside).is(":visible")?"":this.trans.slctPartitionLabel);for(var e=0;e<d.partitionList.length;e++){var f=d.partitionList[e];b++,this.$parent.find(this.objnames.partitionList).append('<li style="border: 1px transparent solid;display:inline-block;width:12em;"><input type="checkbox" name="partitionList['+f.id+']" id="partitionList['+f.id+']" style="border:1px;" value="'+f.id+'" /><label for="partitionList[0]">'+f.text+"</label></li>")}}}0===b?this.$parent.find(this.objnames.partitionListLabel).html(this.trans.slctNoPartition):$.each(a,$.proxy(function(a,b){this.$parent.find('[id="partitionList['+b.id+']"]').prop("checked",!0)},this))},IntegraUserRights.prototype.clearUserTypeAndAccessList=function(){this.$parent.find(this.objnames.profileRightsDetailsHas).text(""),this.$parent.find(this.objnames.profileRightsDetailsDont).text("")},IntegraUserRights.prototype.setUserTypeAndAccessList=function(a,b){if(null!=a){this.$parent.find(this.objnames.userType).val(a),this.$parent.find(this.objnames.profileRightsDetailsHas).html("<b>"+this.trans.userType+": </b><br/>"+this.userTypes[a].name+"<br/>");var c="",d="";$.each(this.userAccess,function(a,e){if(b){var f=$.grep(b,function(a){return a.id==e.id});f.length>0?c+=e.name+"<br/>":d+=e.name+"<br/>"}}),this.$parent.find(this.objnames.profileRightsDetailsHas).html(this.$parent.find(this.objnames.profileRightsDetailsHas).html()+"<b>"+this.trans.rightsListTitle+":</b><br/>"+c),this.$parent.find(this.objnames.profileRightsDetailsHas).data("activeList",b),this.$parent.find(this.objnames.profileRightsDetailsDont).html(d),$.each(b,$.proxy(function(a,b){this.$parent.find('[name="accessList['+b.id+']"]').prop("checked",!0)},this))}},IntegraUserRights.prototype.permissionUserGet=function(){this.$parent.find(this.objnames.profileRightsDetails).val("");var a={integraUserId:this.integraUser_id,integraId:this.integra_id,_token:this.token};if(void 0!==a.integraUserId)$.ajax({url:"/users/puserget",data:a,method:"post",dataType:"json",integraUserRights:this,success:function(a){var b=this.integraUserRights;b.trigger("edit-user-permissionloaded",a),b.partitionList(a.partitionList),b.$parent.find(b.objnames.userCnt).val(a.userCnt),b.$parent.find(b.objnames.userSchemaCnt).val(a.userCnt),b.$parent.find(b.objnames.userSchema).val(a.userSchema),b.setSelectedProfile(0),b.activateSchemaAndCount(a.userType),b.setUserTypeAndAccessList(a.userType,a.accessList),b.activateSave()},error:function(){alert("ERROR!")}});else{var b=this;b.partitionList(void 0),b.setSelectedProfile(0)}},IntegraUserRights.prototype.activateSchemaAndCount=function(a){"2"==a||"3"==a?(this.$parent.find(this.objnames.userCntSection).show(),this.$parent.find(this.objnames.userSchemaSection).hide()):"10"==a?(this.$parent.find(this.objnames.userCntSection).hide(),this.$parent.find(this.objnames.userSchemaSection).show()):(this.$parent.find(this.objnames.userSchemaSection).hide(),this.$parent.find(this.objnames.userCntSection).hide(),this.$parent.find(this.objnames.userCnt).val(""),this.$parent.find(this.objnames.userSchema).val(""))},IntegraUserRights.prototype.loadProfileList=function(a){var b="undefined"!=typeof a?a:!0;this.$parent.find(this.objnames.profileList).empty(),this.$parent.find(this.objnames.profileList).append('<option value="0" data-utype="">'+slctAddNewComboDescr+"</option>"),$.ajax({url:"/admin/profile/json",async:b}).done(function(a){for(var b=0;b<a.length;b++){var c=a[b];this.$parent.find(this.objnames.profileList).append('<option value="'+c.id+'" data-utype="'+c.userType+'">'+c.name+"</option>")}},"json")},IntegraUserRights.prototype.isSaveActive=function(){var a=null!=this.integra_id&&""!=this.integra_id;a=0===this.$parent.find("input[id^='partitionList']:checked").length?!1:a&&!0,a="0"===this.getSelectedProfile()?this.$parent.find("input[name^='accessList']").is(":visible")?a&&this.$parent.find("input[name^='accessList']:checked").length>0:a&&this.$parent.find(this.objnames.profileRightsDetailsHas).data("activeList").length>0:a&&!0;var b=this.$parent.find(this.objnames.userType).val(),c=this.$parent.find(this.objnames.userSchema).val(),d=this.$parent.find(this.objnames.userCnt).val();return a=a&&("2"!=b&&"3"!=b||void 0!==d&&""!==d?!0:!1),a=a&&("10"!=b||void 0!==d&&""!==d||void 0!==c&&""!==c?!0:!1)},IntegraUserRights.prototype.activateSave=function(){var a=this.isSaveActive();this.trigger("edit-user-activate-save",a)},IntegraUserRights.prototype.on=function(a,b,c,d){return this.$parent.on(a,b,c,d)},IntegraUserRights.prototype.trigger=function(a,b){return this.$parent.trigger(a,b)},jQuery(document).ready(function(a){function b(){var b="ws";return"https:"===a(location).attr("protocol")&&(b="wss"),b}function c(b){a("#btn-user-panel").prop("disabled",!0),d(b?"/"+!0:"")}function d(b){var c=a("#hierarchyId").val();a("#integraId").empty(),a("#integraId").val(null).trigger("change"),a.get("/control/"+c+"/jcontrollist"+b,function(b){a.when(s).done(function(){var c=null;a.each(b,function(b,d){c=d.id==p?"selected":null,permissionuserpanels&&void 0!==permissionuserpanels[d.id]?a("#integraId").prepend('<option   data-showcards="'+(void 0===d.showCards?0:d.showCards)+'"   data-useridx="'+permissionuserpanels[d.id].userIdx+'"   data-userid="'+permissionuserpanels[d.id].panelUserId+'"   data-objectid="'+permissionuserpanels[d.id].objectId+'"   value="'+d.id+'"   class="active"   style="font-weight:bold;"   '+c+">"+d.name+"</option>"):a("#integraId").append('<option   data-showcards="'+(void 0===d.showCards?0:d.showCards)+'"   value="'+d.id+'"   '+c+">"+d.name+"</option>")}),k()||a("<option>",{value:"",selected:!0}).prependTo("#integraId"),t.activateSave(),q.resolve(),l(k())})},"json").fail(function(){t.activateSave(),SatelMessageDialog.show({alert:"danger",message:"ERROR"})})}function e(){var b=a("#userId").val();a.get("/users/"+b+"/puserpanels",function(a){permissionuserpanels=a,s.resolve()},"json")}function f(a){return""===a||null===a||void 0===a?!1:a%1===0}function g(b,c,d){var e=a("#btnRemoveUser");a(".integraUserName-label").html(b+c);var f=a("#integra-def-name"),g=a("#integra-def-name-group"),h=a("#integra-def-name-nogroup");"&nbsp;"===c?(g.hide(),f.removeAttr("name"),h.show(),h.attr("name","integraDefName"),a("#integraUserNameBig").removeClass("label-default"),a("#integraUserName").removeClass("label-default"),e.data("title",""),e.data("id",d),e.prop("disabled","disabled")):(c!==a("#integra-def-name").val()?(h.hide(),h.removeAttr("name"),g.show(),f.attr("name","integraDefName")):(g.hide(),f.removeAttr("name"),h.show(),h.attr("name","integraDefName")),a("#integraUserNameBig").addClass("label-default"),a("#integraUserName").addClass("label-default"),e.data("title",a("#trans-remove-confirm").val()+c),e.data("id",d),e.removeAttr("disabled"))}function h(b){var c=a("#integraUsersLinkBtn"),d=a("#btnRemoveUser");f(b)?(c.removeAttr("disabled"),d.removeAttr("disabled")):(c.attr("disabled",!0),d.attr("disabled",!0)),c.data("integraId",b)}function i(){t=new IntegraUserRights(a("#integraUserRightsParent")),t.on("edit-user-prepare-integra",function(){g("","&nbsp;",void 0),a("#btnRemoveUser").prop("disabled","disabled")}),t.on("edit-user-structureloaded",function(a,b){CR.setCardList(b.cardList),j(void 0,"","")}),t.on("edit-user-permissionloaded",function(b,c){c.userName?g('<i   class="fa   fa-calculator"></i>      ',c.userName,c.userId):g("","&nbsp;",void 0),a("#integraId").removeAttr("disabled");var d=a("#integraId   option:selected").data("showcards");j(d?r:void 0,c.userIdx,c.userCardNumber)}),t.on("edit-user-activate-save",function(b,c){var d=a("#scrollHere").parent().closest("div"),e=c&&!(""===d.find("div.integraUserName-label").text().trim()&&""===d.find("#integra-def-name-original").val());a("#btn-user-panel").prop("disabled",!e)}),t.activateSave()}function j(b,c,d){var e=a("button#cardReaderLink");if(f(b)&&f(c)){a("#permUserIntegraEditable").val()>0&&e.removeAttr("disabled");var g=e.prop("title"),h=e.hasClass("cardWarning");""===d||null===d?e.find(".cardAdd").show():e.find(".cardAdd").hide(),h&&g!==d?e.removeClass("cardWarning"):void 0!==CR.checkCardIsUnique(d,c)&&e.addClass("cardWarning")}else e.find(".cardAdd").show(),e.removeClass("cardWarning"),e.attr("disabled",!0);e.data("idintegra",b),e.data("useridx",c),e.data("cardnumber",null===d?"":d),e.prop("title",null===d?m:d)}function k(){return a(window).width()>=(a(document).height()>a(window).height()?978:991)}function l(b){if(b){a("#integraId").attr("multiple","multiple");for(var c=a("#integraId   option:first");c.length>0&&""===c.text()&&""===c.text();)c.remove(),c=a("#integraId   option:first")}else a("#integraId").removeAttr("multiple"),""!==a("#integraId   option:first").text()&&a("<option>",{value:"",selected:!0}).prependTo("#integraId");a("#integraId   option:selected").length>0&&"none"==a(".integraIsSelected").css("display")&&a("#integraId").trigger("change")}var m=a("#trans-cardheader").val(),n=a("#trans-withoutassignedusers-off").val(),o=a("#trans-withoutassignedusers-on").val();a.getJSON("/websocket/options",function(c){var d,e=a(location).attr("port");d="81x"===e?b()+"://"+c.mapoptions.uri+"/integrumservices/integrasocket/":b()+"://"+a(location).attr("host")+"/integrum/integrumservices/integrasocket/",CR.init({uri:d,token:c.token},WS)});var p=null,q=a.Deferred();a("#withoutassignedusers").bootstrapToggle({on:'<i   class="fa   fa-lg   fa-sitemap   subRegionsButtonIco2"   title="'+n+'"></i>',off:'<i   class="fa   fa-sitemap   subRegionsButtonIco"   title="'+o+'"></i>',style:"pull-right"}),a("#withoutassignedusers").change(function(){c(a(this).prop("checked"))});var r,s=a.Deferred(),t=void 0;g("","&nbsp;",void 0),a("#integraId").on("change",function(b){a("#accessList   input[type=checkbox]").prop("checked",!1),r=b.target.value,h(r),g("","&nbsp;",void 0),a("#btnRemoveUser").prop("disabled","disabled");var c=a("#integraId   option:selected").data("objectid"),d=a("#integraId   option:selected").data("userid"),e=a("#userId").val(),f=a("input[name=_token]").val();t&&t.prepareIntegra(r,c,d,e,f),"none"==a(".integraIsSelected").css("display")&&a(document).scrollTop(a("#scrollHere").offset().top-50-10)}),a("#integraUsersLinkBtn").click(function(b){window.location="/control/integrauser/"+a(b.target).closest("button").data("integraId")}),a("#scrollHere").on("keyup","#integra-def-name,   #integra-def-name-nogroup",a.proxy(function(b){var c=a(b.currentTarget),d=a("#integra-def-name-original"),e=a("#integra-def-name-submit");""!==c.val()&&c.val()!=d.val()?(e.addClass("btn-primary"),e.removeClass("btn-default")):(e.addClass("btn-default"),e.removeClass("btn-primary"))},this)),a("form.ajax").on("submit",function(){a("#btn-user-panel").prop("disabled",!0);var b=a(this);return a.ajax({url:b.prop("action"),data:b.serialize(),method:"post",dataType:"json"}).done(function(a){SatelMessageDialog.show(a),t.activateSave()}).fail(function(){SatelMessageDialog.show({alert:"danger",message:"ERROR"}),t.activateSave()}),!1});var u=document.location.toString();if(u.match("#")){var v=u.split("#")[1];""!==v&&(a('.tabs   a[href="#'+u.split("#")[1]+'"]').tab("show"),"user-3"===u.split("#")[1]&&(u.split("#")[2]?(p=u.split("#")[2],q=a.Deferred(),c(a("#withoutassignedusers").prop("checked")),a.when(q).done(function(){r=p,p&&f(p)&&(a("#integraId").val(r),a("#integraId").trigger("change"))})):d(""),e(),void 0===t&&i(),a("#div-label-accessList-btn").hide()))}a(UE).on("ue-activate-tab",function(a,b){"#user-3"===b.hash&&(setHelpLink("ekran-z-danymi-uzytkownika.html#dostep-do-centrali"),e(),d(""),void 0===t&&i(),t.clearPanels())}),a("#objectId,#partitionList").change(function(){t.activateSave()}),a(CR).on("cr-card-added",function(a,b){j(r,b.userIdx,b.cardNumber)}),l(k()),a(window).resize(function(){l(k())}),a("#profileInfo").show()}),jQuery(document).ready(function(a){a("#confirmDelete form.user-destroy").on("submit",function(){var b=a(this).serializeObject();return a.extend(b,{_token:a(this).find("[name=_token]").val(),_method:a(this).find("[name=_method]").val()}),a.ajax({type:b._method||"POST",dataType:"json",url:a(this).attr("action"),data:b,success:function(b){b.status?SatelMessageDialog.show({alert:"info",message:a("#trans-integraAction-message").val()}):SatelMessageDialog.show({alert:"danger",message:b.message,messageDetail:b.messageDetail})}}),!1}),a("#confirmDelete").on("show.bs.modal",function(b){var c=a(b.relatedTarget).data("title")+"?";a(this).find(".modal-title").text(c);var d=a(b.relatedTarget).data("id");a(this).find('.modal-footer input[name="id"]').val(d)}),a("#confirmDelete").find(".modal-footer #confirm").on("click",function(){var b=a(this).parents("form:first");b.submit()})});var WS={options:{uri:void 0,callback:void 0,mapLinkCallback:void 0,actionAttributeCallback:void 0,integraId:void 0,urlPrefix:void 0,debugmode:{websocket:!1,styles:!1,states:!1}},websocket:void 0,reconnectAttempts:1,manualDisconnect:!1,$closer:$("#popup-closer"),loaded:{},init:function(a){$.extend(this.options,a),this.wsTimeout=setTimeout(this.wsTimeout,4e3),this.options.integraId||alert("No INTEGRA!!!");var b=document.createElement("a");if(b.href=this.options.uri,"wss:"===b.protocol||"ws:"===b.protocol)this.websocketUri=this.options.uri+this.options.integraId;else{var c,d=window.location;c="https:"===d.protocol?"wss:":"ws:",c+="//"+d.host,this.websocketUri=c+this.options.uri+this.options.integraId}try{this.websocket=new WebSocket(this.websocketUri),this.websocket.onopen=this.wsOnOpen.bind(this),this.websocket.onclose=this.wsOnClose.bind(this),this.websocket.onmessage=this.wsOnMessage.bind(this),this.websocket.onerror=this.wsOnError.bind(this)}catch(e){console.log(e)}},wsOnOpen:function(){this.reconnectAttempts=1,this.manualDisconnect=!1,this.writeToReceivedBox("CONNECTED"),$(document).trigger("ws-open")},wsOnError:function(){$(document).trigger("ws-error")},wsOnMessage:function(a){var b=this;$(document).trigger("ws-pre-message",a),this.writeToReceivedBox(a.data);var c=JSON.parse(a.data);$.isArray(c)?$.each(c,function(a,c){b.onMessage(c)}):this.onMessage(c),$(document).trigger("ws-post-message",a)},onMessage:function(a){if(a.type)switch(a.type){case"Connected":this.wsConfigRequest(this.options.integraId),clearTimeout(this.wsTimeout);break;case"Config":this.wsRreceivedConfig(a),$(document).trigger("ws-config",a);break;case"State":this.wsReceivedState(a),$(document).trigger("ws-state",a);break;case"ActionResponse":$(document).trigger("ws-action-response",a)}},wsOnClose:function(a){if(/^Apple/.test(navigator.vendor)&&1006===a.code)clearTimeout(this.wsTimeout),this.disposeLoader(),$(document).trigger("ws-error-message",{title:"Error",message:"fatal error"});else if($(document).trigger("ws-close"),this.writeToReceivedBox("DISCONNECTED"),!this.manualDisconnect){var b=this.generateInterval(this.reconnectAttempts);setTimeout(function(){this.reconnectAttempts++,this.wsReconnect(),this.options.debugmode.websocket?console.log("Reconnecting attempt:"+this.reconnectAttempts+" in "+parseInt(b)+"ms"):null}.bind(this),b)}},wsConfigRequest:function(a){this.options.integraId=a;var b={type:"ConfigRequest",token:this.options.token,id:a,action:navigator.language};this.wsSendMessage(JSON.stringify(b))},wsSendMessage:function(a){try{var b=JSON.parse(a),c=$.grep(this.loaded.config.layers,function(a){return a.layerCode===b.layer})[0];$.grep(c.actions,function(a){return a.actionCode===b.action})[0]}catch(d){}if(b.type&&"Action"===b.type){if(b.confirm&&!confirm(this.loaded.config.controls.confirm))return!1;var e=$("<i/>",{"class":"fa fa-cog fa-spin","data-cmd-id":b["cmd-id"]});$("#progress").append(e)}this.writeToSentBox(a),this.websocket.readyState!=this.websocket.CLOSED&&this.websocket.readyState!=this.websocket.CONNECTING&&this.websocket.send(a)},wsReconnect:function(){$("#progress").empty();var a,b;this.loaded&&this.loaded.config&&this.loaded.config.controls?(a=this.loaded.config.controls.disconnected,b=this.loaded.config.controls["disconnected-msg"]):(a="Rozłączono",b="Próbuję ponownie połączyć"),$(document).trigger("ws-error-message",{title:a,message:b}),this.init(this.options)},wsTimeout:function(){$(document).trigger("ws-timeout");var a,b;this.loaded&&this.loaded.config?(a=this.loaded.config.controls.contimeout,b=this.loaded.config.controls["contimeout-msg"]):(a="Timeout",b="Przekroczony czas połączenia."),$(document).trigger("ws-error-message",{title:a,message:b})},wsRreceivedConfig:function(a){$(document).trigger("ws-received-config"),this.loaded.config=a,$(document).trigger("ws-loaded-config",this.loaded.config)},wsRequestState:function(){var a={type:"StateRequest"};this.wsSendMessage(JSON.stringify(a))},wsReceivedState:function(a){$(document).trigger("ws-received-state");var b=[];$(".tooltip").remove(),a.attributes&&$.each(a.attributes,function(a,c,d){"object"==typeof d&&b.push(c+" "+d.join(" "))}.bind(this,a))},wsSendCloseMessage:function(){var a={type:"Close","cmd-id":Date.now().toString()};this.manualDisconnect=!0,this.wsSendMessage(JSON.stringify(a))},disposeLoader:function(){$("#loader").remove()},generateInterval:function(a){var b=1e3*(Math.pow(2,a)-1);return b>3e4&&(b=3e4),Math.random()*b},writeToReceivedBox:function(a){this.options.debugmode.websocket&&console.log("RCV:"+a)},writeToSentBox:function(a){this.options.debugmode.websocket&&console.log("SNT:"+a)}},CR={trans:{removeCardDialogTitle:$("#trans-remove-card-title").val(),qRemoveCard:$("#trans-remove-card-message").val(),placeCard:$("#trans-place-card-message").val(),placeCardAgain:$("#trans-place-again-card-message").val()},manualMode:!1,wsUri:void 0,token:void 0,WS:void 0,$modalAccessControl:void 0,$cardListElem:void 0,cardList:void 0,timeOutMax:200,setCardList:function(a){this.cardList=a},removeCardListItem:function(a){if(void 0!==this.cardList)for(var b=0,c=this.cardList.length;c>b;b++)if(this.cardList[b].idx===a)return this.cardList.splice(b,1),void this.$cardListElem.data("cardlist",this.cardList)},updateCardListItem:function(a){if(void 0!==this.cardList){for(var b=0,c=this.cardList.length;c>b;b++)if(this.cardList[b].idx===a.userIdx)return this.cardList[b].name=a.userName,this.cardList[b].card=a.cardNumber,void this.$cardListElem.data("cardlist",this.cardList);this.cardList.push({idx:a.userIdx,name:a.userName,card:a.cardNumber}),this.$cardListElem.data("cardlist",this.cardList)}},checkCardIsUnique:function(a,b){if(void 0===this.cardList)return void 0;for(var c=0,d=this.cardList.length;d>c;c++)if(this.cardList[c].card===a&&this.cardList[c].idx!==b)return this.cardList[c].name;return void 0},getIdIntegra:function(){return parseInt(this.$modalAccessControl.find("#idIntegra").val())},setIdIntegra:function(a){this.$modalAccessControl.find("#idIntegra").val(a)},getState:function(){return parseInt(this.$modalAccessControl.find("#cardState").val())},getSelectedExpander:function(){return parseInt(this.$modalAccessControl.find("#accessControllers").children(":selected").attr("value"))},getTimer:function(){return parseInt(this.$modalAccessControl.find("#cardTimer").val())},setTimer:function(a){this.$modalAccessControl.find("#cardTimer").val(a)},incTimer:function(){return this.getTimer()+1},getUserIdx:function(){return parseInt(this.$modalAccessControl.find("#userIdx").val())},getUserName:function(){return this.$modalAccessControl.find("#userName").val()},setCardState:function(a){this.$modalAccessControl.find("#cardState").val(a);var b;switch(a){case 2:b=CR.trans.placeCard;break;case 5:b=CR.trans.placeCardAgain;break;default:b=""}this.$modalAccessControl.find("#cardNumer").attr("placeholder",b)},setCardNumber:function(a){var b=this.$modalAccessControl.find("#cardNumer");b.val()!==a&&b.val(a)},getInitialCardNumber:function(){return this.$modalAccessControl.find("#initialCardNumer").val()},getCardNumber:function(){return this.$modalAccessControl.find("#cardNumer").val()},setCardNumberReadOnly:function(a){var b=this.$modalAccessControl.find("#cardNumer");b.prop("readonly",a),a||(b.focus(),b[0].setSelectionRange(0,b.val().length))},setPrevCardNumber:function(a){this.$modalAccessControl.find("#prevCardNumer").val(a)},getPrevCardNumber:function(){return this.$modalAccessControl.find("#prevCardNumer").val()},setDiodeState:function(a){this.$modalAccessControl.find("#activeDiode").removeClass("outlined"),this.$modalAccessControl.find("#activeDiode").removeClass("blink"),this.$modalAccessControl.find("#activeDiode").addClass(a)},isReaderActive:function(a){return void 0===a&&(a=this.getState()),2===a||5===a},isReceivingCard:function(a){return void 0===a&&(a=this.getState()),3===a||6===a},isPreparingReader:function(a){return void 0===a&&(a=this.getState()),1===a||4===a},showErrorMessage:function(a,b){this.$modalAccessControl.find("#message").empty(),(""!==a||""!==b)&&this.$modalAccessControl.find("#message").append('<div class="alert alert-warning alert-dismissible" title="'+a+'">\n<button type="button" class="close" data-dismiss="alert" aria-label="Close">\n<span aria-hidden="true">&times;</span></button>'+b+"</div>")},setCardReadState:function(a,b,c){var d=this.getState();this.setCardState(a),this.setCardNumber(b),this.setTimer(c||0),this.manualMode?(7===a||0===a)&&this.setPrevCardNumber(b):4>a&&this.setPrevCardNumber(b);var e;a>=0?(e="",this.isReaderActive()&&(e="blink")):e="outlined",this.setAccessControllerReadOnly(this.isReaderActive(a)||0>a),this.setDiodeState(e),!this.manualMode&&this.isPreparingReader()?(this.doACAction("prepareReadCard",this.getIdIntegra(),this.getSelectedExpander()),this.setBtnState(!1)):!this.manualMode&&this.isReaderActive(a)?this.checkTimeout()&&(this.doACAction("readCard",this.getIdIntegra(),this.getSelectedExpander()),this.intervalfunc=setInterval("CR.readCard()",500,0)):!this.manualMode&&this.isReceivingCard(a)?d>0&&(parseInt(b,16)>0?3===a?(clearInterval(this.intervalfunc),this.setPrevCardNumber(b),this.checkIsCardValid(!1),this.setCardReadState(a+1,b)):this.getPrevCardNumber()===b?(clearInterval(this.intervalfunc),this.setCardReadState(a+1,b)):this.setCardReadState(1,void 0):this.setCardReadState(a-1,void 0,this.incTimer())):this.manualMode||7!==a?8===a?(this.addDoneOK(this.getPrevCardNumber()),this.setCardReadState(9,void 0)):9===a&&this.$modalAccessControl.modal("hide"):this.setBtnState(!0,!0)},addDoneOK:function(a){var b={integraId:this.getIdIntegra(),userIdx:this.getUserIdx(),userName:this.getUserName(),cardNumber:a};""===a?this.removeCardListItem(this.getUserIdx()):this.updateCardListItem(b),$(this).trigger("cr-card-added",b)},checkTimeout:function(){var a=this.getState();if(this.isReaderActive()){var b=this.getTimer();return this.timeOutMax<b?(this.setCardReadState(0,void 0),!1):!0}return 3===a||6===a?!0:void 0},readCard:function(){this.checkTimeout()},initAccessControllersList:function(a){this.$modalAccessControl.find("#accessControllers").empty(),$.each(a,function(a,b,c){a.find("#accessControllers").append($("<option>",{value:c.id,text:c.text}))}.bind(this,this.$modalAccessControl)),this.$modalAccessControl.find("#accessControllers").append($("<option>",{value:"-1",text:$("#trans-input-local").val()}))},setAccessControllerReadOnly:function(a){this.$modalAccessControl.find("#accessControllers").prop("disabled",a)},getSelectedAccessController:function(){return parseInt(this.$modalAccessControl.find("#accessControllers").val())},setMode:function(a){this.manualMode=a,this.setCardNumberReadOnly(!this.manualMode),this.refreshBtnState(a),this.checkIsCardValid(!1)},doACAction:function(a,b,c){var d={type:"Action","cmd-id":Date.now().toString()};d.id=b,d.action=a,d.layer="INT-INT",d.attributes={},d.attributes.integraId=b,d.attributes.readerIdx=c,this.WS.wsSendMessage(JSON.stringify(d))},saveCard:function(a,b){var c=this.getIdIntegra(),d=this.getUserIdx();0===a.length&&(a="0000000000"),
this.manualMode?this.addCardAction(c,d,a):7===b&&this.addCardAction(c,d,a)},setBtnState:function(a,b){void 0!==a&&this.$modalAccessControl.find("#accessControlDoRead").prop("disabled",!a||this.manualMode),this.$modalAccessControl.find("#accessControlOK").prop("disabled",!b)},refreshBtnState:function(a){this.setBtnState(a?this.$modalAccessControl.find("#accessControlDoRead").prop("disabled"):!0,a?$("#accessControlOK").prop("disabled"):!1)},checkIsCardValid:function(a){function b(a,b,c){return Array(b-String(a).length+1).join(c||"0")+a}var c=this.getCardNumber();if(this.$modalAccessControl.find("#message").empty(),this.manualMode){var d=!1;if(d=0===c.length||10===c.length,d&&c.length>0){var e=parseInt(c,16);if(e===Number.NaN)d=!1;else{d=b(e.toString(16).toUpperCase(),10)===b(c.toUpperCase(),10);var f=this.checkCardIsUnique(c,this.getUserIdx());void 0!==f&&(this.showErrorMessage("","Karta używana przez: "+f),d=!1)}}d?this.setCardReadState(7,c):this.setPrevCardNumber(""),this.setBtnState(void 0,d,void 0===a?!0:!1)}else f=this.checkCardIsUnique(c,this.getUserIdx()),void 0!==f&&(this.showErrorMessage("","Karta używana przez: "+f),d=!1)},addCardAction:function(a,b,c){var d={type:"Action","cmd-id":Date.now().toString()};d.id=a,d.action="addCard",d.layer="INT-INT",d.attributes={},d.attributes.integraId=a,d.attributes.userIdx=b,d.attributes.cardNumber=c,this.WS.wsSendMessage(JSON.stringify(d))},init:function(a,b){function c(a,b){a.find("#nameIntegra").empty();var c=$(b.relatedTarget).data("cardnumber");a.find("#nameIntegra").append($(b.relatedTarget).data("name")),a.find("#idIntegra").attr("value",$(b.relatedTarget).data("idintegra")),a.find("#userIdx").attr("value",$(b.relatedTarget).data("useridx")),a.find("#userName").attr("value",$(b.relatedTarget).data("username")),a.find("#initialCardNumer").attr("value",c),a.find("#remove").attr("disabled",""===c)}this.wsUri=a.uri,this.token=a.token,this.WS=b,this.$modalAccessControl=$("#modalAccessControl"),this.$cardListElem=$("#modalAccessControlCardList"),this.cardList=this.$cardListElem.data("cardlist"),this.$modalAccessControl.on("shown.bs.modal",null,this,function(a){c($(this),a);var b=a.data;b.setCardReadState(-1,$(a.relatedTarget).data("cardnumber")),b.setBtnState(!1),b.WS.init({uri:b.wsUri,token:b.token,integraId:b.getIdIntegra()})}),this.$modalAccessControl.on("hidden.bs.modal",null,this,function(a){var b=a.data;b.WS.wsSendCloseMessage(),b.$modalAccessControl.find("#message").empty()}),$(document).on("ws-open",null,this,function(a){a.data.checkIsCardValid()}),$(document).on("ws-error-message",null,this,function(a,b){a.data.showErrorMessage(b.title,b.message)}),$(document).on("ws-action-response",null,this,function(a,b){var c=a.data.getState();switch(b.respCode){case"1":(a.data.isPreparingReader()||a.data.isReaderActive(c)||7===c)&&a.data.setCardReadState(c+1,b.respMessage,a.data.getTimer());break;default:b.respMessage?a.data.showErrorMessage("Action result",b.respMessage):a.data.showErrorMessage("Action result",b.respCode)}}),$(document).on("ws-loaded-config",null,this,function(a,b){a.data.setCardReadState(0,a.data.getCardNumber()),a.data.setBtnState(!0),a.data.initAccessControllersList(b.accesscontrolers);var c=-1===a.data.getSelectedAccessController();a.data.setMode(c),a.data.setBtnState(!c,c)}),this.$modalAccessControl.find("#cardNumer").on("input",null,this,function(a){a.data.checkIsCardValid()}),this.$modalAccessControl.find("#accessControllers").on("change",null,this,function(a){a.data.setMode("-1"===$("#accessControllers").val()),a.data.manualMode||a.data.setCardReadState(0,a.data.getInitialCardNumber())}),this.$modalAccessControl.find("#accessControlCancel").click(this,function(a){a.data.isReaderActive()?(a.data.setTimer(a.data.timeOutMax+1),a.data.setCardReadState(0,a.data.getInitialCardNumber()),a.data.setBtnState(!0)):a.data.$modalAccessControl.modal("hide")}),this.$modalAccessControl.find("#accessControlOK").click(this,function(a){a.data.saveCard(a.data.getCardNumber(),a.data.getState())}),this.$modalAccessControl.find("#remove").click(this,function(){var a=$("#confirmDeleteCard"),b=CR.trans.qRemoveCard,c=CR.trans.removeCardDialogTitle;a.find(".modal-body p").text(b),a.find(".modal-title").text(c),a.find(".modal-footer #confirm").click(this,function(){CR.saveCard("",7),CR.$modalAccessControl.modal("hide"),CR.addDoneOK("")})}),this.$modalAccessControl.find("#accessControlDoRead").click(this,function(a){return a.data.setCardReadState(1,void 0),!1})}};